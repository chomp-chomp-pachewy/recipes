<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chomp recipes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #fdfdfd;
      color: #3A3A3A;
      line-height: 1.7;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 300px;
      background-color: #f8f8f8;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .recipe-list-container {
      position: relative;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      flex-grow: 1;
      -webkit-overflow-scrolling: touch;
      mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
    }

    .sidebar-header {
      padding: 30px 20px 20px 20px;
      text-align: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 1.6em;
      font-weight: 300;
      color: #fe0032;
      letter-spacing: 0;
      flex-shrink: 0;
    }

    .search-box {
      width: calc(100% - 40px);
      margin: 0 20px 20px 20px;
      padding: 12px 16px;
      font-size: 15px;
      font-family: inherit;
      border: 1px solid #434343;
      border-radius: 8px;
      background-color: #ffffff;
      color: #434343;
      flex-shrink: 0;
    }

    .search-box::placeholder {
      color: #9b9b9b;
    }

    .search-box:focus {
      outline: none;
      border-color: #fe0032;
      box-shadow: 0 0 0 2px rgba(254, 0, 50, 0.12);
    }

    .recipe-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recipe-item {
      padding: 14px 20px;
      cursor: pointer;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.18s ease, color 0.18s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .recipe-item:last-child {
      border-bottom: none;
    }

    .recipe-item:hover {
      background-color: #f0f0f0;
    }

    .recipe-item.active {
      background-color: #fe0032;
      color: #ffffff;
    }

    .recipe-name {
      font-weight: 400;
      font-size: 0.98em;
      line-height: 1.3;
      color: #434343;
    }

    .recipe-item.active .recipe-name {
      color: #ffffff;
    }

    .recipe-content {
      flex: 1;
      overflow-y: auto;
      padding: 40px 60px;
      max-width: 900px;
    }

    .recipe-header {
      margin-bottom: 30px;
    }

    .recipe-title {
      font-size: 2.1em;
      font-weight: 300;
      color: #fe0032;
      margin-bottom: 15px;
      line-height: 1.2;
    }

    .home-text {
      text-align: left;
      padding: 50px 0;
      max-width: 700px;
      margin: 0 auto;
      font-size: 1em;
    }

    .home-text .home-image {
      width: 100%;
      max-width: 260px;
      height: auto;
      margin-bottom: 30px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 8px;
    }

    .recipe-meta {
      color: #646464;
      font-size: 0.95em;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      align-items: center;
    }

    .recipe-meta span {
      position: relative;
      padding-right: 12px;
      font-weight: 400;
    }

    .recipe-meta span:not(:last-child)::after {
      content: "|";
      position: absolute;
      right: 2px;
      top: 50%;
      transform: translateY(-50%);
      color: #b3b3b3;
      font-weight: 300;
      font-size: 0.9em;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .outline-button {
      padding: 7px 14px;
      font-size: 0.9em;
      border-radius: 999px;
      border: 1px solid #fe0032;
      background-color: transparent;
      color: #fe0032;
      cursor: pointer;
      font-weight: 400;
      letter-spacing: 0.01em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.16s ease, color 0.16s ease, box-shadow 0.16s ease, transform 0.08s ease;
    }

    .outline-button:hover {
      background-color: rgba(254, 0, 50, 0.06);
      color: #c90028;
      box-shadow: 0 0 0 1px rgba(254, 0, 50, 0.06);
    }

    .outline-button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .outline-button .icon {
      font-size: 0.9em;
      line-height: 1;
    }

    .recipe-description {
      font-weight: 300;
      line-height: 1.8;
      margin-bottom: 25px;
      font-size: 1em;
    }

    .recipe-image {
      display: block;
      max-width: 50%;
      width: auto;
      height: auto;
      border-radius: 8px;
      margin: 0 auto 20px auto;
    }

    .section-title {
      color: #fe0032;
      font-size: 1.2em;
      font-weight: 700;
      margin: 35px 0 15px 0;
      text-transform: lowercase;
      letter-spacing: 0.02em;
    }

    .ingredients-list {
      list-style: none;
      margin-bottom: 30px;
    }

    .ingredient-item {
      padding: 8px 0 8px 16px;
      border-left: 3px solid #fe0032;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .instructions-list {
      list-style: none;
      counter-reset: step-counter;
      padding-left: 0;
    }

    .instruction-item {
      counter-increment: step-counter;
      margin-bottom: 20px;
      padding-left: 40px;
      position: relative;
      font-weight: 300;
      line-height: 1.8;
    }

    .instruction-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      background-color: #fe0032;
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;
      font-size: 0.9em;
    }

    .notes-section {
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 30px;
      font-weight: 300;
    }

    .notes-section .subheading {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.86em;
    }

    .no-recipe {
      padding: 20px;
      text-align: center;
      color: #666666;
      font-size: 0.95em;
    }

    .no-results {
      padding: 12px 20px 18px;
      font-size: 0.88em;
      color: #777;
      text-align: center;
    }

    .no-results strong {
      color: #fe0032;
      font-weight: 600;
    }

    .scroll-indicator {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 8px 16px 10px;
      font-size: 0.84em;
      text-align: center;
      background: linear-gradient(to top, #f8f8f8 60%, rgba(248, 248, 248, 0));
      color: #666666;
      z-index: 3;
      pointer-events: none;
    }

    .scroll-indicator span {
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background-color: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .scroll-indicator .arrow {
      font-size: 0.9em;
      display: inline-block;
      transform: translateY(0);
      animation: bob 1.4s ease-in-out infinite;
    }

    @keyframes bob {
      0% { transform: translateY(0); opacity: 1; }
      50% { transform: translateY(3px); opacity: 0.75; }
      100% { transform: translateY(0); opacity: 1; }
    }

    a.email-link {
      color: #fe0032;
      font-weight: 700;
      text-decoration: none;
    }

    a.email-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 900px) {
      .recipe-content {
        padding: 26px 22px 26px 22px;
      }

      .recipe-title {
        font-size: 1.6em;
      }

      .home-text {
        padding-top: 30px;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        max-height: 42vh;
      }

      .recipe-content {
        padding: 22px 16px 28px;
      }

      .recipe-image {
        max-width: 80%;
      }

      .recipe-list-container {
        max-height: calc(42vh - 120px);
      }
    }

    @media (max-width: 480px) {
      .sidebar-header {
        padding: 22px 16px 16px 16px;
      }

      .sidebar-title {
        font-size: 1.35em;
      }

      .search-box {
        margin: 0 16px 14px 16px;
      }

      .recipe-item {
        padding: 12px 16px;
      }

      .recipe-content {
        padding: 18px 14px 26px;
      }

      .recipe-title {
        font-size: 1.5em;
      }

      .home-text {
        padding-top: 24px;
      }

      .home-text .home-image {
        max-width: 220px;
      }
    }

    @media print {
      .sidebar,
      .search-box,
      .print-button,
      .copy-link-button,
      .sidebar-header,
      .recipe-list-container,
      .scroll-indicator {
        display: none !important;
      }

      body {
        display: block;
        min-height: auto;
        color: #000000;
      }

      .recipe-content {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
      }

      .recipe-title {
        color: #000000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .recipe-meta,
      .recipe-description {
        color: #333333;
      }

      .section-title {
        color: #333333 !important;
      }

      .notes-section {
        background-color: transparent;
        border: 1px dashed #cccccc;
      }

      .ingredient-item {
        border-left-color: #cccccc !important;
      }

      .instruction-item::before {
        background-color: #000000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* === Unified Dark Mode Palette & Behavior === */
    @media (prefers-color-scheme: dark) {
      :root {
        --dm-bg-main: #0d0d0d;
        --dm-bg-sidebar: #141414;
        --dm-bg-sidebar-alt: #181818;
        --dm-border-subtle: #2a2a2a;
        --dm-text-primary: #e3e3e3;
        --dm-text-muted: #9aa0ac;
        --dm-text-primary-subtle: #c7ccd4;
        --dm-accent-main: #ff4f6b;
        --dm-accent-soft: rgba(255, 79, 107, 0.12);
        --dm-input-bg: #111111;
        --dm-input-border: #333333;
        --dm-indicator-bg: rgba(0, 0, 0, 0.32);
      }

      body {
        background-color: var(--dm-bg-main);
        color: var(--dm-text-primary);
      }

      .sidebar {
        background-color: var(--dm-bg-sidebar);
        border-right-color: var(--dm-border-subtle);
      }

      .recipe-list-container {
        mask-image: linear-gradient(to bottom, black 92%, transparent 100%);
        -webkit-mask-image: linear-gradient(to bottom, black 92%, transparent 100%);
      }

      .sidebar-header {
        border-bottom: 1px solid var(--dm-border-subtle);
      }

      .search-box {
        background-color: var(--dm-input-bg);
        border-color: var(--dm-input-border);
        color: var(--dm-text-primary);
      }

      .search-box::placeholder {
        color: #777c86;
      }

      .search-box:focus {
        border-color: var(--dm-accent-main);
        box-shadow: 0 0 0 2px rgba(255, 79, 107, 0.22);
      }

      .recipe-item {
        border-bottom-color: var(--dm-border-subtle);
      }

      .recipe-item:hover {
        background-color: #1f1f1f;
      }

      .recipe-item.active {
        background-color: var(--dm-accent-main);
      }

      .recipe-item.active .recipe-name {
        color: #ffffff;
      }

      .recipe-name {
        color: var(--dm-text-primary-subtle);
      }

      .recipe-content {
        background-color: var(--dm-bg-main);
        color: var(--dm-text-primary);
      }

      .home-text .recipe-title,
      .home-text .section-title,
      .home-text .recipe-description,
      .home-text a {
        color: var(--dm-accent-main);
      }

      .recipe-title,
      .section-title,
      .copy-link-button,
      .print-button {
        color: #0b0b0b;
      }

      .recipe-meta {
        color: var(--dm-text-muted);
      }

      .recipe-description {
        color: var(--dm-text-primary);
      }

      .ingredient-item {
        border-left-color: var(--dm-accent-main);
      }

      .notes-section {
        background-color: #161616;
        color: var(--dm-text-primary-subtle);
      }

      .scroll-indicator {
        background: linear-gradient(
          to top,
          var(--dm-bg-sidebar-alt) 60%,
          rgba(24, 24, 24, 0)
        );
        color: var(--dm-text-muted);
      }

      .scroll-indicator span {
        background-color: rgba(255, 255, 255, 0.02);
        border-color: rgba(255, 255, 255, 0.04);
      }

      /* Dark-mode sidebar text tone-down */
      .sidebar .recipe-name,
      .sidebar .sidebar-title {
        color: #C7CCD4;
      }

      /* Sticky indicator in dark mode */
      .scroll-indicator {
        background: linear-gradient(
          to top,
          #D6D6D6 60%,
          rgba(24, 24, 24, 0)
        );
      }

      .sidebar {
        background-color: #141414;
      }

      .search-box {
        background-color: #111111;
        border-color: #333333;
        color: #e0e0e0;
      }

      .recipe-item:hover {
        background-color: #232323;
      }

      .recipe-content {
        background-color: #0d0d0d;
        color: #e3e3e3;
      }

      .notes-section {
        background-color: #101010;
      }

      body {
        color: #e3e3e3;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" onclick="resetRecipeView()" style="cursor: pointer;">
      <div class="sidebar-title">Rituals / Recipes</div>
    </div>
    <input type="text" class="search-box" id="searchBox" placeholder="search recipes...">

    <div class="recipe-list-container" id="recipeListContainer">
      <ul class="recipe-list" id="recipeList"></ul>
      <div class="no-results" id="noResults" style="display: none;">
        no recipes found for <strong id="noResultsTerm"></strong>
      </div>
      <div class="scroll-indicator" id="scrollIndicator" style="display: none;">
        <span><span class="arrow">â†“</span> scroll for more recipes</span>
      </div>
    </div>
  </div>

  <div class="recipe-content" id="recipeContent"></div>

  <script>
    let recipes = [];
    let currentRecipe = null;
    let recipesJsonLastModified = null;
    let permalinkBase = 'https://recipes.chomp.ltd';

    const HOME_CONTENT_HTML = `
      <div class="home-text">
        <img src="images/Chomp Chomp logos.jpeg" alt="Chomp Recipes Logo" class="home-image">
        <h1 class="recipe-title" style="font-size:2em;">Rituals & Recipes</h1>
        <h2 class="section-title" style="font-size:1.2em; text-transform:none; font-weight:600; text-decoration:underline;">
          Chomp Chomp's Baking Manifesto
        </h2>
        <h2 class="section-title" style="font-size:1.1em; text-transform:none; margin-top:8px;">
          Ritual and rebellion
        </h2>

        <p class="recipe-description">
          Baking. What is baking, <em>really</em>? It is not simply the combination of flour, sugar, butter, and eggs. No: this would be far too naÃ¯ve. Baking is the materialization of <span style="color:#fe0032;">comfort itself</span>. When we bake, we engage in a ritual that attempts to suspend the chaos of the world through the illusion of control: precise measurements, preheated ovens, perfectly timed rotations of trays. And yet, as any baker knows, this control is always incomplete. The cake may rise, or it may collapse; the dough may refuse to proof. The oven, that domestic abyss, stares back.
        </p>

        <p class="recipe-description">
          But in this gap (between intention and outcome) lies the <span style="color:#fe0032;">zen of baking</span>. We submit ourselves to a process that resists total mastery. The mind quiets as the hands work. The self dissolves into the rhythm of kneading, folding, and whisking. In baking, the most mundane gestures become philosophical: the transformation of raw matter into something tender, fragrant, <span style="color:#fe0032;">shareable</span>. Is this not, in a way, an allegory of all human creation? We impose form upon chaos, and call it dessert.
        </p>

        <p class="recipe-description">
          Culturally, baking binds us in a way that predates language. Across centuries and continents, <span style="color:#fe0032;">the act of sharing</span> bread, cake, or cookie functions as a social contract - a small edible utopia. You offer someone a slice, a biscuit, a still-warm loaf, and for a fleeting moment the alienation of modern life is suspended. Even the recipes themselves - whether original inventions, found online, or passed from one colleagueâ€™s grandmother to anotherâ€™s notebook - form a <span style="color:#fe0032;">network</span> of borrowed gestures and shared <span style="color:#fe0032;">community</span>.
        </p>

        <p class="recipe-description">
          So, as you explore these recipes, remember: you are not merely reproducing instructions. You are reenacting an ancient dialectic between chaos and order, solitude and <span style="color:#fe0032;">community</span>, scarcity and indulgence. You are, in the truest sense, baking the <span style="color:#fe0032;">striving toward transcendence</span>.
        </p>

        <h2 class="section-title" style="font-size:1.2em; text-transform:none;">Bake first, theorize later</h2>

        <p class="recipe-description">
          Scroll through the recipes, or search by keyword.
        </p>

        <p class="recipe-description">
          Of course, as with all things in life, the search itself may be more revealing than the findingâ€”the keyword is merely <span style="color:#fe0032;">the symptom of desire</span>!
        </p>

        <p class="recipe-description">
          Because baking, like theory, thrives on exchange and variation, Iâ€™m always looking for something new. If you have a recipe - your grandmotherâ€™s secret torte, your own <span style="color:#fe0032;">subversive</span> take on the cookie, or something you found in a forgotten corner of the internet - please send it to me. Iâ€™ll add it here, with full credit, so that our <span style="color:#fe0032;">collective archive</span> of baked transcendence may continue to grow.
        </p>

        <p class="recipe-description">
          <a href="mailto:baking@chomp.ltd" class="email-link">baking@chomp.ltd</a>
        </p>
      </div>
    `;

    function resetRecipeView() {
      document.querySelectorAll('.recipe-item').forEach(item => item.classList.remove('active'));
      document.getElementById('recipeContent').innerHTML = HOME_CONTENT_HTML;
      currentRecipe = null;
      updateURLForHome();
    }

    function sortRecipesAlphabetically() {
      recipes.sort((a, b) =>
        a.title.toLowerCase() < b.title.toLowerCase() ? -1 :
        a.title.toLowerCase() > b.title.toLowerCase() ? 1 : 0
      );
    }

    async function loadRecipes() {
      try {
        const response = await fetch('recipes.json', { cache: 'no-cache' });

        const lastModified = response.headers.get('Last-Modified');
        if (recipesJsonLastModified && lastModified === recipesJsonLastModified) {
          initializeFromURL();
          return;
        }

        recipesJsonLastModified = lastModified;
        recipes = await response.json();
        sortRecipesAlphabetically();
        displayRecipeList(recipes);
        initializeFromURL();
        setupScrollIndicator();
      } catch (error) {
        console.error('Error loading recipes:', error);
        document.getElementById('recipeContent').innerHTML =
          '<div class="no-recipe">Error loading recipes. Please check <code>recipes.json</code>.</div>';
      }
    }

    function displayRecipeList(recipesToShow) {
      const recipeList = document.getElementById('recipeList');
      const noResults = document.getElementById('noResults');
      const noResultsTerm = document.getElementById('noResultsTerm');

      recipeList.innerHTML = '';

      if (!recipesToShow.length) {
        const searchTerm = document.getElementById('searchBox').value.trim();
        noResultsTerm.textContent = searchTerm || 'your search';
        noResults.style.display = 'block';
        return;
      }

      noResults.style.display = 'none';

      recipesToShow.forEach(recipe => {
        const li = document.createElement('li');
        li.className = 'recipe-item';
        li.onclick = () => selectRecipe(recipe, li);
        li.innerHTML = `<div class="recipe-name">${recipe.title}</div>`;
        li.dataset.slug = recipe.slug || '';
        recipeList.appendChild(li);
      });

      setupScrollIndicator();
    }

    function buildRecipeMeta(recipe) {
      const metaInfo = [];
      if (recipe.prepTime) metaInfo.push(`<span>prep: ${recipe.prepTime}</span>`);
      if (recipe.cookTime) metaInfo.push(`<span>cook: ${recipe.cookTime}</span>`);
      if (recipe.totalTime) metaInfo.push(`<span>total: ${recipe.totalTime}</span>`);
      if (recipe.servings) metaInfo.push(`<span>servings: ${recipe.servings}</span>`);
      if (recipe.source) metaInfo.push(`<span>source: ${recipe.source}</span>`);
      if (recipe.category && recipe.category !== 'null') metaInfo.push(`<span>category: ${recipe.category}</span>`);
      return metaInfo.join('');
    }

    function getPermalinkForRecipe(recipe) {
      const slug = recipe.slug || slugifyTitle(recipe.title);
      return `${permalinkBase}?r=${encodeURIComponent(slug)}`;
    }

    function slugifyTitle(title) {
      if (!title) return '';
      return title
        .toLowerCase()
        .replace(/['"]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function selectRecipe(recipe, element, skipURLUpdate = false) {
      currentRecipe = recipe;

      document.querySelectorAll('.recipe-item').forEach(item => item.classList.remove('active'));
      if (element) {
        element.classList.add('active');
        element.scrollIntoView({ block: 'nearest' });
      } else {
        const matchingItem = findSidebarItemForRecipe(recipe);
        if (matchingItem) {
          matchingItem.classList.add('active');
          matchingItem.scrollIntoView({ block: 'nearest' });
        }
      }

      const content = document.getElementById('recipeContent');
      const metaHTML = buildRecipeMeta(recipe);
      const imageHTML = recipe.image ? `<img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">` : '';
      const descriptionHTML = recipe.description ? `<div class="recipe-description">${recipe.description}</div>` : '';
      const ingredientsHTML = (recipe.ingredients || []).map(i => {
        if (typeof i === 'string' && i.trim().startsWith('###')) {
          const label = i.replace(/^###\s*/, '').trim();
          return `<li class="ingredient-item"><span class="subheading">${label}</span></li>`;
        }
        return `<li class="ingredient-item">${i}</li>`;
      }).join('');
      const instructionsHTML = (recipe.instructions || []).map(i => `<li class="instruction-item">${i}</li>`).join('');
      const notesHTML = recipe.notes
        ? `<div class="section-title">notes</div><div class="notes-section">${recipe.notes}</div>`
        : '';

      const permalink = getPermalinkForRecipe(recipe);

      content.innerHTML = `
        <div class="recipe-header">
          <h1 class="recipe-title">${recipe.title}</h1>
          <div class="recipe-meta">${metaHTML}</div>
          <div class="button-row">
            <button onclick="printRecipe()" class="outline-button print-button">
              <span class="icon">ðŸ–¨</span> Print
            </button>
            <button onclick="copyPermalink('${permalink}')" class="outline-button copy-link-button">
              <span class="icon">ðŸ”—</span> Permalink
            </button>
          </div>
        </div>
        ${descriptionHTML}
        ${imageHTML}
        <div class="section-title">ingredients</div>
        <ul class="ingredients-list">${ingredientsHTML}</ul>
        <div class="section-title">instructions</div>
        <ol class="instructions-list">${instructionsHTML}</ol>
        ${notesHTML}
      `;

      if (!skipURLUpdate) {
        updateURLForRecipe(recipe);
      }
    }

    function findSidebarItemForRecipe(recipe) {
      const slug = recipe.slug || slugifyTitle(recipe.title);
      const items = document.querySelectorAll('.recipe-item');
      for (const item of items) {
        if (item.dataset.slug === slug) return item;
        const name = item.querySelector('.recipe-name');
        if (name && name.textContent.trim() === recipe.title.trim()) {
          return item;
        }
      }
      return null;
    }

    function updateURLForRecipe(recipe) {
      const slug = recipe.slug || slugifyTitle(recipe.title);
      const newUrl = `${window.location.pathname}?r=${encodeURIComponent(slug)}`;
      if (window.location.search !== `?r=${encodeURIComponent(slug)}`) {
        window.history.replaceState({ slug }, '', newUrl);
      }
    }

    function updateURLForHome() {
      if (window.location.search) {
        const newUrl = window.location.pathname;
        window.history.replaceState({}, '', newUrl);
      }
    }

    function initializeFromURL() {
      const params = new URLSearchParams(window.location.search);
      const slugParam = params.get('r');

      document.getElementById('recipeContent').innerHTML = HOME_CONTENT_HTML;

      if (slugParam) {
        const decodedSlug = decodeURIComponent(slugParam);
        let recipe = recipes.find(r => r.slug === decodedSlug);
        if (!recipe) {
          recipe = recipes.find(r => slugifyTitle(r.title) === decodedSlug);
        }
        if (recipe) {
          selectRecipe(recipe, null, true);
          return;
        }
      }
      resetRecipeView();
    }

    function printRecipe() {
      window.print();
    }

    function copyPermalink(permalink) {
      if (!navigator.clipboard) {
        const tempInput = document.createElement('input');
        tempInput.value = permalink;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
      } else {
        navigator.clipboard.writeText(permalink);
      }

      const btns = document.querySelectorAll('.copy-link-button');
      btns.forEach(btn => {
        const original = btn.textContent.trim();
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.innerHTML = '<span class="icon">ðŸ”—</span> Permalink';
        }, 1600);
      });
    }

    function setupScrollIndicator() {
      const container = document.getElementById('recipeListContainer');
      const indicator = document.getElementById('scrollIndicator');
      const list = document.getElementById('recipeList');

      if (!container || !indicator || !list) return;

      const width = window.innerWidth || document.documentElement.clientWidth;
      const children = list.children;
      let thresholdCount = width <= 768 ? 3 : 10;

      if (!children || children.length <= thresholdCount) {
        indicator.style.display = 'none';
        return;
      }

      const hasVerticalScroll = container.scrollHeight > container.clientHeight + 4;

      if (!hasVerticalScroll) {
        indicator.style.display = 'none';
        return;
      }

      indicator.style.display = 'block';

      const handleScroll = () => {
        const { scrollTop, scrollHeight, clientHeight } = container;
        if (scrollTop + clientHeight >= scrollHeight - 12) {
          indicator.style.opacity = '0';
          indicator.style.pointerEvents = 'none';
        } else {
          indicator.style.opacity = '1';
          indicator.style.pointerEvents = 'auto';
        }
      };

      container.removeEventListener('scroll', handleScroll);
      container.addEventListener('scroll', handleScroll, { passive: true });

      handleScroll();
    }

    window.addEventListener('resize', () => {
      setupScrollIndicator();
    });

    document.getElementById('searchBox').addEventListener('input', e => {
      const searchTerm = e.target.value.toLowerCase();
      const filtered = recipes.filter(r =>
        r.title.toLowerCase().includes(searchTerm) ||
        (r.description && r.description.toLowerCase().includes(searchTerm)) ||
        (r.ingredients || []).some(i =>
          (typeof i === 'string') && i.toLowerCase().includes(searchTerm)
        )
      );
      displayRecipeList(filtered);
    });

    window.addEventListener('DOMContentLoaded', () => {
      loadRecipes();
    });
  </script>
</body>
</html>