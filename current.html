<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>chomp recipes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Inter for manifesto; system stack for app chrome -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --accent: #fe0032;
      --accent-dark: #b80022;
      --bg-main: #fdfdfd;
      --bg-sidebar: #f6f6f6;
      --text-main: #222222;
      --text-muted: #666666;
      --border-subtle: #e0e0e0;
      --sticky-shadow: rgba(0, 0, 0, 0.08);
      --meta-text: #555555;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
      line-height: 1.7;
      display: flex;
      min-height: 100vh;
    }

    /* Layout */
    .sidebar {
      width: 300px;
      background-color: var(--bg-sidebar);
      border-right: 1px solid var(--border-subtle);
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .sidebar-header {
      padding: 30px 20px 20px 20px;
      text-align: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 1.6em;
      font-weight: 300;
      color: var(--accent);
      /* no forced lowercase */
      letter-spacing: 0.02em;
    }

    .search-box {
      width: calc(100% - 40px);
      margin: 0 20px 16px 20px;
      padding: 11px 14px;
      font-size: 14px;
      font-family: inherit;
      border: 1px solid #b5b5b5;
      border-radius: 8px;
      background-color: #ffffff;
      color: #333333;
      flex-shrink: 0;
    }

    .search-box::placeholder {
      color: #9a9a9a;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(254, 0, 50, 0.1);
    }

    .recipe-list-container {
      position: relative;
      max-height: calc(100vh - 160px);
      overflow-y: auto;
      flex-grow: 1;
      padding-bottom: 40px;
    }

    .recipe-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .recipe-item {
      padding: 12px 18px;
      cursor: pointer;
      border-bottom: 1px solid #ececec;
      transition: background-color 0.18s ease, color 0.18s ease;
      font-size: 0.95rem;
    }

    .recipe-item:last-child {
      border-bottom: none;
    }

    .recipe-item:hover {
      background-color: #efefef;
    }

    .recipe-item.active {
      background-color: var(--accent);
      color: #ffffff;
    }

    .recipe-name {
      font-weight: 400;
      font-size: 0.98rem;
      color: inherit;
    }

    .recipe-time {
      display: inline-block;
      margin-top: 4px;
      font-size: 0.78rem;
      color: #8a8a8a;
    }

    .recipe-item.active .recipe-time {
      color: rgba(255, 255, 255, 0.85);
    }

    .no-results {
      padding: 12px 18px;
      font-size: 0.9rem;
      color: #999999;
    }

    /* Sticky scroll indicator row */
    .sticky-indicator {
      position: sticky;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 8px 18px 10px;
      font-size: 0.8rem;
      background: rgba(250, 250, 250, 0.94);
      color: #333333;
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 3;
      transition: opacity 0.2s ease;
    }

    .sticky-indicator.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .sticky-indicator span {
      white-space: nowrap;
    }

    .scroll-note-label {
      font-weight: 500;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      font-size: 0.72rem;
    }

    .scroll-note-dots {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 7px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: rgba(255, 255, 255, 0.9);
    }

    .scroll-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #bbbbbb;
    }

    .scroll-dot.active {
      width: 7px;
      height: 7px;
      background: var(--accent);
    }

    .scroll-note-arrow {
      font-size: 0.85rem;
      transform: translateY(1px);
    }

    /* Top shadow when sidebar is scrolled */
    .top-shadow {
      position: sticky;
      top: 0;
      width: 100%;
      height: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      background: linear-gradient(
          to bottom,
          rgba(253, 253, 253, 1) 0%,
          rgba(253, 253, 253, 0) 90%
        ),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.12), rgba(0, 0, 0, 0));
      z-index: 2;
    }

    .top-shadow.visible {
      opacity: 1;
    }

    /* Main content */
    .recipe-content {
      flex: 1;
      overflow-y: auto;
      padding: 40px 60px;
      max-width: 900px;
      margin: 0 auto;
    }

    .recipe-header {
      margin-bottom: 30px;
    }

    .recipe-title {
      font-size: 2rem;
      font-weight: 300;
      color: var(--accent);
      margin-bottom: 16px;
      line-height: 1.2;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    .recipe-meta {
      color: var(--meta-text);
      font-size: 0.9rem;
      margin-bottom: 18px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      align-items: center;
    }

    .recipe-meta span::before {
      content: "";
    }

    .recipe-meta span + span::before {
      content: "|";
      margin: 0 7px 0 3px;
      color: #c0c0c0;
    }

    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .button-row .print-button,
    .button-row .link-button {
      padding: 6px 10px;
      font-size: 0.85rem;
      background-color: transparent;
      color: var(--meta-text);
      border: 1px solid rgba(0, 0, 0, 0.28);
      border-radius: 999px;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease,
        border-color 0.2s ease, transform 0.08s ease;
      font-weight: 500;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .button-row .print-button:hover,
    .button-row .link-button:hover {
      border-color: var(--accent);
      color: var(--accent);
      background-color: rgba(254, 0, 50, 0.04);
      transform: translateY(-0.5px);
    }

    .button-row .print-button:active,
    .button-row .link-button:active {
      transform: translateY(0.5px);
    }

    .recipe-description {
      font-weight: 300;
      line-height: 1.9;
      margin-bottom: 24px;
      font-size: 0.98rem;
      max-width: 720px;
    }

    .recipe-image {
      display: block;
      max-width: 50%;
      width: auto;
      height: auto;
      border-radius: 8px;
      margin: 0 auto 20px auto;
    }

    .section-title {
      color: var(--accent);
      font-size: 1.1rem;
      font-weight: 600;
      margin: 32px 0 14px 0;
      text-transform: lowercase;
      letter-spacing: 0.04em;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    .ingredients-list {
      list-style: none;
      margin-bottom: 30px;
      padding-left: 0;
    }

    .ingredient-item {
      padding: 7px 0 7px 16px;
      border-left: 3px solid var(--accent);
      margin-bottom: 6px;
      font-weight: 300;
      font-size: 0.96rem;
    }

    .ingredient-item.subheading {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.78rem;
      border-left-color: rgba(0, 0, 0, 0.08);
      color: #555555;
      margin-top: 16px;
    }

    .instructions-list {
      list-style: none;
      counter-reset: step-counter;
      padding-left: 0;
    }

    .instruction-item {
      counter-increment: step-counter;
      margin-bottom: 18px;
      padding-left: 40px;
      position: relative;
      font-weight: 300;
      line-height: 1.9;
      font-size: 0.97rem;
    }

    .instruction-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 26px;
      height: 26px;
      background-color: var(--accent);
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 0.78rem;
    }

    .notes-section {
      background-color: #f7f7f7;
      padding: 18px;
      border-radius: 8px;
      margin-top: 26px;
      font-weight: 300;
      font-size: 0.94rem;
      border: 1px dashed #dddddd;
    }

    .no-recipe {
      padding: 20px;
      text-align: center;
      color: #777777;
      font-size: 0.95rem;
    }

    a.email-link {
      color: var(--accent);
      font-weight: 700;
      text-decoration: none;
    }

    a.email-link:hover {
      text-decoration: underline;
    }

    /* Home / manifesto view */
    .home-text {
      text-align: left;
      padding: 48px 0 60px;
      max-width: 720px;
      margin: 0 auto;
      font-size: 0.98rem;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    .home-text .home-image {
      width: 100%;
      max-width: 260px;
      height: auto;
      margin-bottom: 28px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .home-text .recipe-title {
      font-size: 1.95rem;
      margin-bottom: 12px;
      color: var(--accent);
      font-weight: 300;
    }

    .home-text .section-title {
      font-size: 1.02rem;
      text-transform: none;
      letter-spacing: 0.01em;
      margin-bottom: 18px;
      color: var(--accent);
    }

    .home-text .section-title strong {
      font-weight: 600;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    .home-text .recipe-description {
      font-size: 0.98rem;
      margin-bottom: 18px;
      color: #262626;
    }

    .home-text .recipe-description span {
      color: var(--accent);
      font-weight: 500;
    }

    .home-text a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    .home-text a:hover {
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .recipe-content {
        padding: 22px 18px 28px;
      }

      .home-text {
        padding-top: 32px;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
        max-height: 46vh;
      }

      .recipe-content {
        padding: 20px 18px 28px;
      }

      .recipe-image {
        max-width: 82%;
      }

      .recipe-title {
        font-size: 1.7rem;
      }

      .home-text .recipe-title {
        font-size: 1.8rem;
      }

      .home-text .home-image {
        max-width: 230px;
      }

      .recipe-list-container {
        max-height: calc(46vh - 120px);
      }
    }

    @media (max-width: 480px) {
      .sidebar-header {
        padding: 22px 16px 12px;
      }

      .sidebar-title {
        font-size: 1.3rem;
      }

      .search-box {
        margin: 0 16px 12px 16px;
      }

      .recipe-item {
        padding: 10px 14px;
      }

      .sticky-indicator {
        padding: 6px 14px 8px;
      }
    }

    /* Print styles */
    @media print {
      .sidebar,
      .search-box,
      .print-button,
      .link-button,
      .sidebar-header,
      .recipe-list-container,
      .sticky-indicator,
      .top-shadow {
        display: none !important;
      }

      body {
        display: block;
        min-height: auto;
        color: #000000;
        background: #ffffff !important;
      }

      .recipe-content {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 0;
      }

      .recipe-title {
        color: #000000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .recipe-meta,
      .recipe-description {
        color: #333333;
      }

      .section-title {
        color: #333333 !important;
      }

      .notes-section {
        background-color: transparent;
        border: 1px dashed #cccccc;
      }

      .ingredient-item {
        border-left-color: #cccccc !important;
      }

      .instruction-item::before {
        background-color: #000000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }

    /* Dark mode tweaks */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #101010;
        color: #e6e6e6;
      }

      .recipe-content {
        background-color: #101010;
      }

      .sidebar {
        background-color: #f6f6f6; /* keep light sidebar in dark mode */
        border-right-color: #3a3a3a;
      }

      .search-box {
        background-color: #ffffff;
        border-color: #999999;
        color: #222222;
      }

      .search-box::placeholder {
        color: #999999;
      }

      .recipe-item {
        border-bottom-color: #dddddd;
        color: #333333;
      }

      .recipe-item:hover {
        background-color: #ececec;
      }

      .recipe-item.active {
        background-color: var(--accent-dark);
        color: #ffffff;
      }

      .recipe-item.active .recipe-name {
        color: #ffffff;
      }

      .recipe-item.active .recipe-time {
        color: rgba(255, 255, 255, 0.88);
      }

      .sticky-indicator {
        background: rgba(235, 235, 235, 0.92);
        color: #2a2a2a;
        border-top-color: rgba(0, 0, 0, 0.08);
      }
    }

    .top-shadow {
      position: sticky;
      top: 0;
      width: 100%;
      height: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      background: linear-gradient(
          to bottom,
          rgba(253, 253, 253, 1) 0%,
          rgba(253, 253, 253, 0) 90%
        ),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
    }

    .top-shadow.visible {
      opacity: 1;
    }

    @media (prefers-color-scheme: dark) {
      .top-shadow {
        background: linear-gradient(
            to bottom,
            rgba(20, 20, 20, 1) 0%,
            rgba(20, 20, 20, 0) 90%
          ),
          linear-gradient(to bottom, rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0));
      }
    }

    @media (prefers-color-scheme: dark) {
      .recipe-content {
        background-color: #101010;
      }

      .recipe-title {
        color: #f4f4f4;
      }

      .recipe-meta {
        color: #b9c3cf;
      }

      .button-row .print-button,
      .button-row .link-button {
        border-color: rgba(255, 255, 255, 0.3);
        color: #d5dde7;
        background-color: transparent;
      }

      .button-row .print-button:hover,
      .button-row .link-button:hover {
        border-color: var(--accent-dark);
        color: var(--accent-dark);
        background-color: rgba(184, 0, 34, 0.12);
      }

      .section-title {
        color: var(--accent-dark);
      }

      .ingredient-item {
        border-left-color: var(--accent-dark);
      }

      .notes-section {
        background-color: #181818;
        border-color: #3b3b3b;
        color: #e0e0e0;
      }

      .instruction-item::before {
        background-color: var(--accent-dark);
      }
    }

    /* Dark mode: manifesto styling */
    @media (prefers-color-scheme: dark) {
      .home-text .recipe-title {
        color: var(--accent-dark);
      }

      .home-text .section-title {
        color: var(--accent-dark);
      }

      .home-text .recipe-description {
        color: #e6e6e6;
      }

      .home-text a {
        color: var(--accent-dark);
      }
    }

    /* Soften accent-colored inline spans in manifesto body text on dark mode */
    @media (prefers-color-scheme: dark) {
      .home-text .recipe-description span {
        color: #b80022 !important;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" onclick="resetRecipeView()" style="cursor: pointer;">
      <div class="sidebar-title">Rituals / Recipes</div>
    </div>

    <input
      type="text"
      class="search-box"
      id="searchBox"
      placeholder="search recipes..."
    />

    <div class="top-shadow" id="topShadow"></div>

    <div class="recipe-list-container" id="recipeListContainer">
      <ul class="recipe-list" id="recipeList"></ul>
      <div class="no-results" id="noResults" style="display: none;">
        no recipes found
      </div>
    </div>

    <div class="sticky-indicator hidden" id="scrollIndicator">
      <span class="scroll-note-label">scroll for more</span>
      <span class="scroll-note-dots" aria-hidden="true">
        <span class="scroll-dot"></span>
        <span class="scroll-dot active"></span>
        <span class="scroll-dot"></span>
      </span>
      <span class="scroll-note-arrow">↓</span>
    </div>
  </div>

  <div class="recipe-content" id="recipeContent"></div>

  <script>
    let recipes = [];
    let currentRecipe = null;

    function printRecipe() {
      window.print();
    }

    function copyPermalink() {
      if (!currentRecipe) return;
      const base = "https://recipes.chomp.ltd";
      const slug = currentRecipe.slug || slugify(currentRecipe.title);
      const url = `${base}?recipe=${encodeURIComponent(slug)}`;

      navigator.clipboard
        .writeText(url)
        .then(() => {
          alert("Permalink copied:\n" + url);
        })
        .catch((err) => {
          console.error("Clipboard error:", err);
          alert("Permalink: " + url);
        });
    }

    function slugify(text) {
      return text
        .toString()
        .toLowerCase()
        .trim()
        .replace(/['"]/g, "")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    const HOME_CONTENT_HTML = `
  <div class="home-text">
    <img src="images/Chomp Chomp logos.jpeg" alt="Chomp Recipes Logo" class="home-image">
    
    <h1 class="recipe-title">Rituals &amp; Recipes</h1>
    
    <h2 class="section-title">
      <strong>Chomp Chomp's Baking Manifesto</strong><br />
      ritual and rebellion
    </h2>

    <p class="recipe-description">
      Baking. What is baking, <em>really</em>? It is not simply the combination of flour, sugar, butter, and eggs. No: this would be far too naïve. Baking is the materialization of <span>comfort itself</span>. When we bake, we engage in a ritual that attempts to suspend the chaos of the world through the illusion of control: precise measurements, preheated ovens, perfectly timed rotations of trays. And yet, as any baker knows, this control is always incomplete. The cake may rise, or it may collapse; the dough may refuse to proof. The oven, that domestic abyss, stares back.
    </p>

    <p class="recipe-description">
      But in this gap (between intention and outcome) lies the <span>zen of baking</span>. We submit ourselves to a process that resists total mastery. The mind quiets as the hands work. The self dissolves into the rhythm of kneading, folding, and whisking. In baking, the most mundane gestures become philosophical: the transformation of raw matter into something tender, fragrant, <span>shareable</span>. Is this not, in a way, an allegory of all human creation? We impose form upon chaos, and call it dessert.
    </p>

    <p class="recipe-description">
      Culturally, baking binds us in a way that predates language. Across centuries and continents, <span>the act of sharing</span> bread, cake, or cookie functions as a social contract - a small edible utopia. You offer someone a slice, a biscuit, a still-warm loaf, and for a fleeting moment the alienation of modern life is suspended. Even the recipes themselves - whether original inventions, found online, or passed from one colleague’s grandmother to another’s notebook - form a <span>network</span> of borrowed gestures and shared <span>community</span>.
    </p>

    <p class="recipe-description">
      So, as you explore these recipes, remember: you are not merely reproducing instructions. You are reenacting an ancient dialectic between chaos and order, solitude and <span>community</span>, scarcity and indulgence. You are, in the truest sense, baking the <span>striving toward transcendence</span>.
    </p>

    <h2 class="section-title">Bake first, theorize later</h2>

    <p class="recipe-description">
      Scroll through the recipes, or search by keyword.
    </p>

    <p class="recipe-description">
      Of course, as with all things in life, the search itself may be more revealing than the finding—the keyword is merely <span>the symptom of desire</span>!
    </p>

    <p class="recipe-description">
      Because baking, like theory, thrives on exchange and variation, I’m always looking for something new. If you have a recipe - your grandmother’s secret torte, your own <span>subversive</span> take on the cookie, or something you found in a forgotten corner of the internet - please send it to me. I’ll add it here, with full credit, so that our <span>collective archive</span> of baked transcendence may continue to grow.
    </p>

    <p class="recipe-description">
      <a href="mailto:baking@chomp.ltd">baking@chomp.ltd</a>
    </p>
  </div>
`;

    function resetRecipeView() {
      document
        .querySelectorAll(".recipe-item")
        .forEach((item) => item.classList.remove("active"));
      document.getElementById("recipeContent").innerHTML = HOME_CONTENT_HTML;
      currentRecipe = null;
      updatePermalinkForHome();
    }

    function sortRecipesAlphabetically() {
      recipes.sort((a, b) =>
        a.title.toLowerCase() < b.title.toLowerCase()
          ? -1
          : a.title.toLowerCase() > b.title.toLowerCase()
          ? 1
          : 0
      );
    }

    async function loadRecipes() {
      try {
        const response = await fetch("recipes.json");
        recipes = await response.json();
        sortRecipesAlphabetically();
        displayRecipeList(recipes);
        restoreInitialSelectionFromPermalink();
        setupSidebarScrollEffects();
      } catch (error) {
        console.error("Error loading recipes:", error);
        document.getElementById("recipeContent").innerHTML =
          '<div class="no-recipe">error loading recipes</div>';
      }
    }

    function displayRecipeList(recipesToShow) {
      const recipeList = document.getElementById("recipeList");
      const noResults = document.getElementById("noResults");
      recipeList.innerHTML = "";

      if (!recipesToShow.length) {
        noResults.style.display = "block";
        return;
      }

      noResults.style.display = "none";

      recipesToShow.forEach((recipe) => {
        const li = document.createElement("li");
        li.className = "recipe-item";
        li.dataset.slug = recipe.slug || slugify(recipe.title);

        li.onclick = () => {
          selectRecipe(recipe, li, true);
        };

        const timeBits = [];
        if (recipe.totalTime) {
          timeBits.push(`total: ${recipe.totalTime}`);
        } else {
          if (recipe.prepTime) timeBits.push(`prep: ${recipe.prepTime}`);
          if (recipe.cookTime) timeBits.push(`cook: ${recipe.cookTime}`);
        }

        const metaSnippet = timeBits.length
          ? `<div class="recipe-time">${timeBits.join(" | ")}</div>`
          : "";

        li.innerHTML = `
        <div class="recipe-name">${recipe.title}</div>
        ${metaSnippet}
      `;
        recipeList.appendChild(li);
      });

      updateScrollIndicator();
    }

    function selectRecipe(recipe, element, updateUrl = false) {
      currentRecipe = recipe;

      document
        .querySelectorAll(".recipe-item")
        .forEach((item) => item.classList.remove("active"));
      if (element) element.classList.add("active");

      const content = document.getElementById("recipeContent");

      let metaInfo = [];
      if (recipe.prepTime) metaInfo.push(`<span>prep: ${recipe.prepTime}</span>`);
      if (recipe.cookTime) metaInfo.push(`<span>cook: ${recipe.cookTime}</span>`);
      if (recipe.totalTime)
        metaInfo.push(`<span>total: ${recipe.totalTime}</span>`);
      if (recipe.servings)
        metaInfo.push(`<span>servings: ${recipe.servings}</span>`);
      if (recipe.source) metaInfo.push(`<span>source: ${recipe.source}</span>`);
      if (recipe.category && recipe.category !== "null")
        metaInfo.push(`<span>category: ${recipe.category}</span>`);

      let imageHTML = recipe.image
        ? `<img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">`
        : "";
      let descriptionHTML = recipe.description
        ? `<div class="recipe-description">${recipe.description}</div>`
        : "";
      const ingredientsHTML = recipe.ingredients
        .map((i) => {
          if (i.trim().startsWith("###")) {
            const clean = i.replace(/^###\s*/, "").trim();
            return `<li class="ingredient-item subheading">${clean}</li>`;
          }
          return `<li class="ingredient-item">${i}</li>`;
        })
        .join("");
      const instructionsHTML = recipe.instructions
        .map((i) => `<li class="instruction-item">${i}</li>`)
        .join("");
      let notesHTML = recipe.notes
        ? `<div class="section-title">notes</div><div class="notes-section">${recipe.notes}</div>`
        : "";

      const slug = recipe.slug || slugify(recipe.title);
      const permalink = `https://recipes.chomp.ltd?recipe=${encodeURIComponent(
        slug
      )}`;

      content.innerHTML = `
      <div class="recipe-header">
        <h1 class="recipe-title">${recipe.title}</h1>
        <div class="recipe-meta">${metaInfo.join("")}</div>
        <div class="button-row">
          <button onclick="printRecipe()" class="print-button">Print</button>
          <button onclick="copyPermalink()" class="link-button" title="${permalink}">Permalink</button>
        </div>
      </div>
      ${descriptionHTML}
      ${imageHTML}
      <div class="section-title">ingredients</div>
      <ul class="ingredients-list">${ingredientsHTML}</ul>
      <div class="section-title">instructions</div>
      <ol class="instructions-list">${instructionsHTML}</ol>
      ${notesHTML}
    `;

      if (updateUrl) {
        const url = new URL(window.location);
        url.searchParams.set("recipe", slug);
        window.history.replaceState({}, "", url);
      }
    }

    function updatePermalinkForHome() {
      const url = new URL(window.location);
      url.searchParams.delete("recipe");
      window.history.replaceState({}, "", url);
    }

    function restoreInitialSelectionFromPermalink() {
      try {
        const url = new URL(window.location.href);
        const recipeSlug = url.searchParams.get("recipe");
        if (!recipeSlug) {
          resetRecipeView();
          return;
        }

        const target = recipes.find(
          (r) => (r.slug || slugify(r.title)) === recipeSlug
        );
        if (!target) {
          resetRecipeView();
          return;
        }

        const list = document.getElementById("recipeList");
        const li = list.querySelector(`[data-slug="${recipeSlug}"]`);
        selectRecipe(target, li || null, false);

        if (li) {
          const container = document.getElementById("recipeListContainer");
          const liOffsetTop = li.offsetTop;
          const liHeight = li.offsetHeight;
          const containerHeight = container.clientHeight;
          container.scrollTop = liOffsetTop - containerHeight / 2 + liHeight / 2;
        }
      } catch (err) {
        console.error("Error restoring selection from permalink:", err);
        resetRecipeView();
      }
    }

    function setupSidebarScrollEffects() {
      const container = document.getElementById("recipeListContainer");
      const indicator = document.getElementById("scrollIndicator");
      const topShadow = document.getElementById("topShadow");

      if (!container || !indicator || !topShadow) return;

      function handleScroll() {
        const scrollTop = container.scrollTop;
        const maxScroll =
          container.scrollHeight - container.clientHeight - 1;

        if (scrollTop > 4) {
          topShadow.classList.add("visible");
        } else {
          topShadow.classList.remove("visible");
        }

        if (maxScroll <= 0) {
          indicator.classList.add("hidden");
          return;
        }

        if (scrollTop >= maxScroll - 4) {
          indicator.classList.add("hidden");
        } else {
          indicator.classList.remove("hidden");
        }
      }

      handleScroll();
      container.addEventListener("scroll", handleScroll);
      window.addEventListener("resize", handleScroll);
    }

    function updateScrollIndicator() {
      const container = document.getElementById("recipeListContainer");
      const indicator = document.getElementById("scrollIndicator");
      const topShadow = document.getElementById("topShadow");
      if (!container || !indicator || !topShadow) return;

      const scrollTop = container.scrollTop;
      const maxScroll =
        container.scrollHeight - container.clientHeight - 1;
      const hasOverflow = maxScroll > 0;

      if (!hasOverflow) {
        indicator.classList.add("hidden");
        topShadow.classList.remove("visible");
        return;
      }

      if (scrollTop > 4) {
        topShadow.classList.add("visible");
      } else {
        topShadow.classList.remove("visible");
      }

      if (scrollTop >= maxScroll - 4) {
        indicator.classList.add("hidden");
      } else {
        indicator.classList.remove("hidden");
      }
    }

    document
      .getElementById("searchBox")
      .addEventListener("input", (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = recipes.filter(
          (r) =>
            r.title.toLowerCase().includes(searchTerm) ||
            (r.description &&
              r.description.toLowerCase().includes(searchTerm)) ||
            r.ingredients.some((i) =>
              i.toLowerCase().includes(searchTerm)
            )
        );
        displayRecipeList(filtered);
      });

    loadRecipes();
  </script>
</body>
</html>