<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chomp Chomp: Recipes & Rituals</title>

  <!-- Favicon -->
  <link rel="icon" type="image/jpeg" href="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Fchomp_recipes_logo.jpeg?alt=media">

  <!-- Open Graph / Social Media Preview Tags -->
  <meta property="og:title" content="Chomp Chomp: Recipes & Rituals">
  <meta property="og:description" content="Browse our complete collection of baking recipes and culinary rituals.">
  <meta property="og:image" content="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Fchomp_recipes.png?alt=media">
  <meta property="og:url" content="https://recipes.chomp.ltd/recipes.html">
  <meta property="og:type" content="website">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Shared Stylesheet -->
  <link rel="stylesheet" href="styles.css">

  <style>
    /* Additional recipe-specific styles */
    .recipe-search-box {
      width: 100%;
      max-width: 500px;
      margin: 0 auto 30px auto;
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      background-color: white;
      color: var(--color-text);
    }

    .recipe-search-box:focus {
      outline: none;
      border-color: var(--color-accent);
    }

    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      background-color: white;
      color: var(--color-text);
    }

    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--color-text-muted);
      font-size: 1.1em;
    }
  </style>
</head>
<body>

  <!-- Site Header / Navigation -->
  <header class="site-header">
    <nav class="site-nav">
      <div style="display: flex; align-items: center; gap: 12px;">
        <a href="index.html" title="Home" style="display: flex; align-items: center;">
          <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/posts%2Fimages%2F1764578247902_Chomp%20Chomp%20main%20logo.PNG?alt=media&token=2a72eee4-53a7-4365bceb-c77c33950133"
               alt="Chomp Chomp"
               style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
        </a>
      </div>

      <button class="menu-toggle" onclick="toggleMenu()">☰</button>

      <ul class="nav-links" id="navLinks">
        <li><a href="index.html">Home</a></li>
        <li><a href="recipes.html" class="active">Recipes</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="page-container">

    <!-- Page Title -->
    <section class="content-wrapper text-center mb-xl">
      <a href="index.html" title="Back to Home" style="text-decoration: none; display: block;">
        <img src="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Frecipes%20logo.jpeg?alt=media"
             alt="Chomp Recipes Logo"
             style="max-width: 300px; margin: 0 auto 30px auto; display: block; border-radius: 8px; cursor: pointer; transition: opacity 0.2s;"
             onmouseover="this.style.opacity='0.8'"
             onmouseout="this.style.opacity='1'">
      </a>

      <h1>Recipes & Rituals</h1>
      <p class="text-muted">Browse, search, and discover your next baking adventure</p>
    </section>

    <!-- Search & Filter Controls -->
    <section class="content-wrapper">
      <div class="filter-controls">
        <input type="text"
               class="recipe-search-box"
               id="recipeSearch"
               placeholder="Search recipes by name, ingredient, or keyword..."
               style="flex: 1; min-width: 200px; max-width: 500px; margin: 0;">
        <select id="categoryFilter">
          <option value="all">All Categories</option>
          <!-- Categories will be populated dynamically -->
        </select>

        <select id="dishTypeFilter">
          <option value="all">All Dish Types</option>
          <!-- Dish types will be populated dynamically -->
        </select>

        <select id="sortBy">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="newest">Sort: Newest</option>
          <option value="time">Sort: Quickest Time</option>
        </select>

        <button class="btn btn-outline" onclick="clearFilters()">Clear Filters</button>
      </div>
    </section>

    <!-- Recipe Grid -->
    <section class="recipe-grid" id="recipeGrid">
      <!-- Recipes will be dynamically loaded here -->
      <div class="no-results" id="noResults" style="display: none; grid-column: 1 / -1;">
        No recipes found. Try adjusting your filters.
      </div>
    </section>

    <!-- Load More Button -->
    <div class="text-center mt-xl">
      <button class="btn btn-primary" id="loadMoreBtn" onclick="loadMoreRecipes()" style="display: none;">
        Load More Recipes
      </button>
    </div>

  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="footer-content">
      <p>Baking is the materialization of comfort itself.</p>
      <div class="footer-links">
        <a href="mailto:baking@chomp.ltd">baking@chomp.ltd</a>
        <a href="https://www.chomp.ltd" target="_blank">chomp chomp: cookies, etc.</a>
        <a href="https://tools.chomp.ltd" target="_blank">chomp chomp: tools</a>
      </div>
      <p style="margin-top: 20px; font-size: 0.85em;">&copy; 2025 Chomp Chomp</p>
    </div>
  </footer>

  <!-- Firebase SDK and Recipe Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId;

    let recipes = [];
    let displayedRecipes = 0;
    const RECIPES_PER_PAGE = 15;

    // Helper: Generate slug from title
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    }

    // Helper: Parse time strings
    function parseTime(timeString) {
      if (!timeString) return Infinity;
      const rangeMatch = String(timeString).match(/^(\d+)/);
      const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
      const hoursMatch = String(timeString).match(/(\d+)\s*h/);
      const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
      const minutesMatch = String(timeString).match(/(\d+)\s*min/);
      const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;

      if (hours + minutes > 0) return hours + minutes;
      else if (rangeMinutes > 0) return rangeMinutes;
      return Infinity;
    }

    // Helper: Assign dish type based on title
    function assignDishType(title) {
      const lower = title.toLowerCase();
      if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
      if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
      if (lower.includes('custard')) return 'Frozen Dessert';
      if (lower.includes('pudding')) return 'Pudding/Cream';
      if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish';
      if (lower.includes('soup')) return 'Soup';
      return 'Other Baked Goods';
    }

    // Helper: Check if string is JSON
    function isSafeJson(str) {
      if (typeof str !== 'string') return false;
      str = str.trim();
      return (str.startsWith('{') && str.endsWith('}')) || (str.startsWith('[') && str.endsWith(']'));
    }

    // Load recipes from Firestore
    function setupRecipeListener() {
      const recipesRef = collection(db, `artifacts/${appId}/public/data/recipes`);
      const q = query(recipesRef);

      onSnapshot(q, (snapshot) => {
        recipes = snapshot.docs.map(doc => {
          const data = doc.data();

          // Parse serialized JSON fields
          if (typeof data.ingredients === 'string' && isSafeJson(data.ingredients)) {
            try { data.ingredients = JSON.parse(data.ingredients); }
            catch (e) { data.ingredients = []; }
          }

          if (typeof data.source === 'string' && isSafeJson(data.source)) {
            try { data.source = JSON.parse(data.source); }
            catch (e) { data.source = String(data.source); }
          }

          return {
            ...data,
            slug: data.slug || generateSlug(data.title),
            totalTimeInMinutes: parseTime(data.totalTime || data.cookTime),
            dishType: assignDishType(data.title)
          };
        });

        populateFilters();
        applyFiltersAndDisplay();
      }, (error) => {
        console.error("Error loading recipes:", error);
        document.getElementById('noResults').style.display = 'block';
        document.getElementById('noResults').textContent = 'Failed to load recipes. Please check your connection.';
      });
    }

    // Populate filter dropdowns
    function populateFilters() {
      const categories = [...new Set(recipes.map(r => r.category).filter(c => c))].sort();
      const dishTypes = [...new Set(recipes.map(r => r.dishType).filter(d => d))].sort();

      const categoryFilter = document.getElementById('categoryFilter');
      const dishTypeFilter = document.getElementById('dishTypeFilter');

      categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');

      dishTypeFilter.innerHTML = '<option value="all">All Dish Types</option>' +
        dishTypes.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    // Apply filters and sort, then display
    function applyFiltersAndDisplay() {
      const searchTerm = document.getElementById('recipeSearch').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const dishType = document.getElementById('dishTypeFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      // Filter recipes
      let filtered = recipes.filter(r => {
        const matchesSearch = !searchTerm ||
          r.title.toLowerCase().includes(searchTerm) ||
          (r.description && r.description.toLowerCase().includes(searchTerm)) ||
          (Array.isArray(r.ingredients) && r.ingredients.some(i => i.toLowerCase().includes(searchTerm)));

        const matchesCategory = category === 'all' || r.category === category;
        const matchesDishType = dishType === 'all' || r.dishType === dishType;

        return matchesSearch && matchesCategory && matchesDishType;
      });

      // Sort recipes
      if (sortBy === 'time') {
        filtered.sort((a, b) => a.totalTimeInMinutes - b.totalTimeInMinutes);
      } else if (sortBy === 'newest') {
        filtered.reverse();
      } else {
        filtered.sort((a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase()));
      }

      displayRecipes(filtered);
    }

    // Display recipes in grid
    function displayRecipes(recipesToShow) {
      const grid = document.getElementById('recipeGrid');
      const noResults = document.getElementById('noResults');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      if (recipesToShow.length === 0) {
        grid.innerHTML = '';
        noResults.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        return;
      }

      noResults.style.display = 'none';
      displayedRecipes = Math.min(RECIPES_PER_PAGE, recipesToShow.length);

      grid.innerHTML = recipesToShow.slice(0, displayedRecipes).map(recipe => {
        const timeText = recipe.totalTimeInMinutes === Infinity ? 'Time N/A' : `${recipe.totalTimeInMinutes} min`;
        const imagePath = recipe.image
          ? (recipe.image.startsWith('http') ? recipe.image : `images/${recipe.image}`)
          : null;

        return `
          <article class="recipe-card" onclick="window.location.href='recipe.html?slug=${recipe.slug}'">
            ${imagePath
              ? `<img src="${imagePath}" alt="${recipe.title}" class="recipe-card-image">`
              : '<div class="post-tile-placeholder">No Image Available</div>'
            }
            <div class="recipe-card-content">
              <h3 class="recipe-card-title">${recipe.title}</h3>
              <p class="card-description" style="font-size: 0.9em; color: var(--color-text-muted); margin: 8px 0;">
                ${recipe.description ? recipe.description.substring(0, 100) + '...' : 'A delicious recipe waiting to be made!'}
              </p>
              <div class="recipe-card-time">${timeText}</div>
            </div>
          </article>
        `;
      }).join('');

      loadMoreBtn.style.display = displayedRecipes < recipesToShow.length ? 'inline-block' : 'none';
      window.currentFilteredRecipes = recipesToShow;
    }

    // Load more recipes
    window.loadMoreRecipes = function() {
      const recipesToShow = window.currentFilteredRecipes || recipes;
      displayedRecipes += RECIPES_PER_PAGE;
      displayRecipes(recipesToShow);
    }

    // Clear all filters
    window.clearFilters = function() {
      document.getElementById('recipeSearch').value = '';
      document.getElementById('categoryFilter').value = 'all';
      document.getElementById('dishTypeFilter').value = 'all';
      document.getElementById('sortBy').value = 'alphabetical';
      applyFiltersAndDisplay();
    }

    // Event listeners
    document.getElementById('recipeSearch').addEventListener('input', applyFiltersAndDisplay);
    document.getElementById('categoryFilter').addEventListener('change', applyFiltersAndDisplay);
    document.getElementById('dishTypeFilter').addEventListener('change', applyFiltersAndDisplay);
    document.getElementById('sortBy').addEventListener('change', applyFiltersAndDisplay);

    // Initialize
    setupRecipeListener();
  </script>

  <!-- Navigation toggle for mobile -->
  <script>
    function toggleMenu() {
      const navLinks = document.getElementById('navLinks');
      navLinks.classList.toggle('active');
    }
  </script>

</body>
</html>
