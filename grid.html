<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chomp recipes</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------------------------------------------- */
    /* === BASE STYLES & LAYOUT === */
    /* ---------------------------------------------------- */

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fdfdfd;
      color: #353535;
      line-height: 1.7;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 300px;
      background-color: #f5f5f5;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .recipe-list-container {
      position: relative;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      flex-grow: 1;
      /* Mask for fading effect at the bottom */
      mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
    }

    .sidebar-header {
      padding: 30px 20px 20px 20px;
      text-align: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 1.6em;
      font-weight: 300;
      color: #e73b42;
      flex-shrink: 0;
    }

    /* ---------------------------------------------------- */
    /* === SEARCH, SORT & LIST ITEMS (SIDEBAR) === */
    /* ---------------------------------------------------- */

    .search-box {
      width: calc(100% - 40px);
      margin: 0 20px 20px 20px;
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #434343;
      border-radius: 8px;
      background-color: #ffffff;
      color: #7d7d7d;
      flex-shrink: 0;
    }

    .search-box:focus { outline: none; border-color: #e73b42; }

    .recipe-list { list-style: none; padding: 0; margin: 0; }

    .recipe-item {
      padding: 14px 14px;
      cursor: pointer;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.2s;
      color: #7d7d7d;
    }

    .recipe-item:last-child { border-bottom: none; }

    .recipe-item:hover { background-color: #f0f0f0; }

    .recipe-item.active {
      background-color: #e73b42;
      color: #ffffff;
    }

    .recipe-name {
      font-weight: 400;
      font-size: .9em;
    }

    .recipe-item.active .recipe-time { color: rgba(255, 255, 255, 0.8); }

    /* Sticky Indicator and Shadow */
    .sticky-indicator {
      position: sticky;
      bottom: 0;
      text-align: center;
      background: rgba(253,253,253,0.9);
      padding: 8px 0;
      font-size: 0.85em;
      color: #777;
      opacity: 1;
      transition: opacity 0.3s ease;
      display: none;
    }

    .top-shadow {
      position: sticky;
      top: 0;
      width: 100%;
      height: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      background:
        linear-gradient(to bottom,
          rgba(253,253,253,1) 0%,
          rgba(253,253,253,0) 90%),
        linear-gradient(to bottom,
          rgba(0,0,0,0.15),
          rgba(0,0,0,0));
    }


    /* ---------------------------------------------------- */
    /* === RECIPE CONTENT & HOME VIEW === */
    /* ---------------------------------------------------- */

    .recipe-content {
      flex: 1;
      overflow-y: auto;
      padding: 80px 50px;
      max-width: 1200px; 
      margin: 0 auto;
    }

    .recipe-header { margin-bottom: 25px; }

    .recipe-title {
      font-size: 1.9em;
      font-weight: 450;
      color: #e73b42;
      margin-bottom: 25px;
      line-height: 1.2;
    }

    .recipe-meta {
      color: #9d9d9d;
      font-size: 0.90em;
      margin-bottom: 25px;
    }
    .recipe-meta span { margin-right: 0 !important; }

    /* Base styles for description (used for both recipe and manifesto) */
    .recipe-description {
      font-weight: 300;
      line-height: 1.8;
      margin-bottom: 25px;
      font-size: 1em;
    }

    .recipe-image {
      display: block;
      max-width: 50%;
      width: auto;
      height: auto;
      border-radius: 8px;
      margin: 0 auto 20px auto;
    }

    /* Home/Manifesto Specific Styles */
    .home-text {
      text-align: left;
      padding: 0;
      max-width: 750px;
      margin: 0 auto;
      font-size: 1.05em;
      font-family: 'Inter', sans-serif;
      line-height: 1.85;
    }

    .home-text .home-image {
      width: 100%;
      max-width: 300px;
      height: auto;
      margin-bottom: 30px;
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .home-text .recipe-title {
      font-weight: 550 !important;
      margin-bottom: 15px;
    }

    .home-text,
    .home-text .recipe-description {
      color: #353535 !important;
      font-size: 1em !important;
      line-height: 1.9 !important;
    }

    /* ---------------------------------------------------- */
    /* === GRID VIEW STYLES & CONTROLS === */
    /* ---------------------------------------------------- */
    .grid-view {
      padding: 40px 50px;
      max-width: 1200px; /* Adjusted max-width */ 
      margin: 0 auto;
    }

    .recipe-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 30px;
    }

    .recipe-card {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .recipe-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card-image {
      width: 100%;
      height: 200px; 
      object-fit: cover;
      border-bottom: 1px solid #e0e0e0;
    }

    .card-image-placeholder {
      width: 100%;
      height: 200px;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      color: #9d9d9d;
      font-weight: 300;
      border-bottom: 1px solid #e0e0e0;
    }

    .card-content {
      padding: 15px;
    }

    .card-title {
      font-size: 1.15em;
      font-weight: 600;
      color: #353535;
      margin-bottom: 5px;
      line-height: 1.3;
    }

    .card-description {
      font-size: 0.9em;
      color: #7d7d7d;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }

    .card-time {
      font-size: 0.8em;
      color: #e73b42;
      font-weight: 600;
    }

    .grid-controls {
      display: flex;
      flex-wrap: wrap; 
      gap: 15px;
      align-items: center;
      justify-content: flex-start;
      padding: 0 10px;
    }

    .grid-controls select {
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    
    .clear-filters-btn {
      font-family: 'Inter', sans-serif !important;
      font-size: 0.9em;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid #9d9d9d;
      color: #7d7d7d;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .clear-filters-btn:hover {
      border-color: #E73B42;
      color: #7d7d7d;
    }

    /* ---------------------------------------------------- */
    /* === RATING SPECIFIC STYLES (Kept for later use) === */
    /* ---------------------------------------------------- */
    /* NOTE: Display of these elements is currently disabled in JS */
    .rating-container {
        display: none; /* Temporarily hidden */
        align-items: center;
        gap: 10px;
        margin-top: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    .stars-display {
        font-size: 1.5em;
        color: #ffc107;
        letter-spacing: -2px;
    }
    /* ... (Rest of rating styles hidden) */


    /* ---------------------------------------------------- */
    /* === ACTIONS & SECTIONS (FULL RECIPE) === */
    /* ---------------------------------------------------- */

    .recipe-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .recipe-action-button {
      font-family: 'Inter', sans-serif !important;
      font-size: 0.95em;
      padding: 6px 10px;
      background: transparent;
      border: 1px solid #E73B42;
      color: #E73B42;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .recipe-action-button:hover {
      background-color: #E73B42;
      color: white;
    }

    .section-title {
      color: #E73B42;
      font-size: 1.2em;
      font-weight: 700;
      margin: 20px 0 20px 0;
    }

    .ingredients-list { list-style: none; margin-bottom: 25px; }

    .ingredient-item {
      padding: 6px 0 6px 16px;
      border-left: 3px solid #E73B42;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .instructions-list { list-style: none; counter-reset: step-counter; }

    .instruction-item {
      counter-increment: step-counter;
      margin-bottom: 20px;
      padding-left: 40px;
      position: relative;
      font-weight: 300;
      line-height: 1.8;
    }

    .instruction-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      background-color: #E73B42;
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;
      font-size: 0.9em;
    }

    .notes-section {
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: 300;
    }

    .no-recipe {
      padding: 20px;
      text-align: center;
      color: #666666;
      font-size: 0.95em;
    }

    a.email-link { color: #E73B42; font-weight: 700; text-decoration: none; }

    /* Links in recipe content (from markdown parsing) */
    .recipe-content a { color: #E73B42; font-weight: 400; text-decoration: none; }

    /* ---------------------------------------------------- */
    /* === MEDIA QUERIES === */
    /* ---------------------------------------------------- */

    @media (max-width: 768px) {
      .recipe-list-container { max-height: calc(56px * 3); }
      body { flex-direction: column; }
      .sidebar { 
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        max-height: 40vh;
      }
      .recipe-content { padding: 20px; }
      .recipe-image { max-width: 80%; }
      
      .recipe-cards-container { grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); }
      .grid-controls { flex-direction: column; align-items: stretch; }
    }

    @media print {
      .sidebar, .search-box, .print-button, .copy-link-button, .sidebar-header, .recipe-list-container, .recipe-actions, .recipe-action-button, .grid-controls, .pagination-area, .rating-container {
        display: none !important;
      }
      body { display: block; min-height: auto; color: #000000; }
      .recipe-content { width: 100%; max-width: 100%; margin: 0; padding: 0; }
      .recipe-title { color: #000000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .recipe-meta, .recipe-description { color: #333333; }
      .section-title { color: #333333 !important; }
      .notes-section { background-color: transparent; border: 1px dashed #cccccc; }
      .ingredient-item { border-left-color: #cccccc !important; }
      .instruction-item::before { background-color: #000000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" onclick="resetRecipeView()" style="cursor: pointer;">
      <div class="sidebar-title">Rituals / Recipes</div>
      <a href="#grid" id="gridViewLink" style="font-size:0.85em; color: #E73B42; margin-top: 5px; display: block; text-decoration: none;">View All Recipes (Grid)</a>
    </div>
    
    <div style="padding: 0 20px 10px 20px; flex-shrink: 0;">
      <select id="sidebar-sort-by" style="width:100%; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="newest">Sort: Newest</option>
          <option value="time">Sort: Quickest Time</option>
      </select>
    </div>

    <input type="text" class="search-box" id="searchBox" placeholder="search recipes...">
    
    <div class="recipe-list-container">
        <ul class="recipe-list" id="recipeList"></ul>
        <div id="stickyIndicator" class="sticky-indicator"></div>
        <div class="top-shadow"></div>
        <div class="no-results" id="noResults" style="display: none;">no recipes found</div>
    </div>
  </div>

  <div class="recipe-content" id="recipeContent"></div>

  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, query, updateDoc, setDoc, getDoc, runTransaction, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION (MANDATORY GLOBALS) ---
    // The hosting environment MUST provide these global variables:
    // __app_id, __firebase_config, __initial_auth_token
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'chomp-chomp-recipes'; 
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
        apiKey: "YOUR_FIREBASE_API_KEY", 
        projectId: "chomp-chomp-recipes",
        // The hosting environment will inject the correct live keys here.
    }));
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let userId = null;
    let recipes = [];
    let currentRecipe = null;
    let currentGridPage = 0;
    const RECIPES_PER_PAGE = 15;
    let isAuthReady = false;
    
    // --- FIREBASE COLLECTION PATHS ---
    function getRecipesCollectionPath() {
        return `artifacts/${appId}/public/data/recipes`;
    }
    function getRatingsCollectionPath() {
        // Keeping path definition even though rating logic is commented out/removed
        return `artifacts/${appId}/public/data/ratings`;
    }
    function getRatingDocPath(recipeSlug, userId) {
        return doc(db, getRatingsCollectionPath(), `${recipeSlug}_${userId}`);
    }
    function getAggregateRatingDocPath(recipeSlug) {
        return doc(db, getRatingsCollectionPath(), recipeSlug);
    }
    
    // --- AUTHENTICATION & INITIALIZATION ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
        }
        isAuthReady = true;
        setupRecipeListener(); 
    });

    async function initAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
            } catch (error) {
                console.error("Error signing in with custom token, falling back to anonymous:", error);
                await signInAnonymously(auth);
            }
        } else {
            await signInAnonymously(auth);
        }
    }
    
    // --- REAL-TIME RECIPE LISTENER (Pulls ALL content from Firestore) ---
    function setupRecipeListener() {
        const recipesRef = collection(db, getRecipesCollectionPath());
        const q = query(recipesRef);

        onSnapshot(q, (snapshot) => {
            let initialLoad = recipes.length === 0;
            
            recipes = snapshot.docs.map(doc => {
                const data = doc.data();
                
                // Handling serialized JSON fields created by the migration script
                if (typeof data.ingredients === 'string') {
                    try { data.ingredients = JSON.parse(data.ingredients); } catch (e) { console.error("Failed to parse ingredients JSON string:", e); }
                }
                if (typeof data.source === 'string') {
                    try { data.source = JSON.parse(data.source); } catch (e) { console.error("Failed to parse source JSON string:", e); }
                }

                return {
                    ...data,
                    // Ensure slug exists for linking
                    slug: data.slug || generateSlug(data.title),
                    totalTimeInMinutes: parseTime(data.totalTime || data.cookTime),
                    dishType: assignDishType(data.title),
                    // Set rating scores to 0 since we are NOT displaying them
                    ratingScore: 0, 
                    ratingCount: 0
                };
            });

            sortRecipes(recipes, 'alphabetical');
            displayRecipeList(recipes);
            updateStickyIndicator(); 
            
            if (initialLoad) {
                if (window.location.hash === '#grid') {
                    displayGridPage(recipes);
                } else if (!openRecipeFromURL()) {
                    resetRecipeView();
                }
                // Removed setupRatingListener call
            }
        }, (error) => {
            console.error("Error setting up recipe listener:", error);
            document.getElementById('recipeContent').innerHTML = `<div class="no-recipe"><p>Failed to load recipes from the database. Please ensure data has been migrated and Firebase config is correct.</p></div>`;
        });
    }

    // Removed all rating listener and submission functions (setupRatingListener, submitRating, renderRatingUI, formatRating)
    
    // --- UTILITIES ---
    
    function printRecipe() { window.print(); }

    function generateSlug(title) {
        return title
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim('-');
    }

    function parseMarkdown(text) {
        if (!text) return text;
        
        // Handle complex array structures returned by the migration script for ingredients/source
        if (typeof text === 'object' && Array.isArray(text)) {
            return text.map(item => {
                if (typeof item === 'string') return item;
                if (Array.isArray(item)) return item.map(subItem => {
                    if (subItem && subItem.text) return `<a href="${subItem.href}" target="_blank" rel="noopener noreferrer">${subItem.text}</a>`;
                    return subItem;
                }).join(' ');
                return item;
            }).join(' '); // Join complex array items with a space for display simplicity
        }

        // Standard Markdown links
        text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        
        return text;
    }

    function copyPermalink() {
        if (!currentRecipe || !currentRecipe.slug) return;
        const url = `${window.location.origin}${window.location.pathname}?slug=${encodeURIComponent(currentRecipe.slug)}`;
        navigator.clipboard.writeText(url).then(() => {
            console.log('Permalink copied to clipboard!');
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    }

    function parseTime(timeString) {
        if (!timeString) return Infinity; 
        const rangeMatch = String(timeString).match(/^(\d+)/);
        const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
        const hoursMatch = String(timeString).match(/(\d+)\s*h/);
        const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
        const minutesMatch = String(timeString).match(/(\d+)\s*min/);
        const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
        
        if (hours + minutes > 0) {
            return hours + minutes;
        } else if (rangeMinutes > 0) {
            return rangeMinutes;
        }
        return Infinity;
    }

    function assignDishType(title) {
        const lower = title.toLowerCase();
        if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
        if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
        if (lower.includes('custard')) return 'Frozen Dessert';
        if (lower.includes('pudding')) return 'Pudding/Cream';
        if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish'; 
        if (lower.includes('soup')) return 'Soup'; 
        return 'Other Baked Goods';
    }
    
    function sortRecipes(recipesToSort, sortBy) {
        switch (sortBy) {
            case 'time':
                recipesToSort.sort((a, b) => a.totalTimeInMinutes - b.totalTimeInMinutes);
                break;
            case 'newest':
                recipesToSort.reverse(); 
                break;
            case 'alphabetical':
            default:
                recipesToSort.sort((a, b) => 
                    a.title.toLowerCase() < b.title.toLowerCase() ? -1 : 
                    a.title.toLowerCase() > b.title.toLowerCase() ? 1 : 0
                );
                break;
        }
    }

    const HOME_CONTENT_HTML = `
      <div class="home-text">
          <img src="Chomp Chomp logos.jpeg" alt="Chomp Recipes Logo" class="home-image">
          <h1 class="recipe-title" style="font-size:1.8em;">Recipes & Rituals</h1>
          <h2 class="section-title manifesto-title" style="font-size:1.2em;">
            <span class="manifesto-line-1">A Baking Manifesto</span>
          </h2>
          <!-- (REST OF HOME CONTENT OMITTED FOR BREVITY) -->
          <p class="recipe-description">
          Baking. What is baking, <em>really</em>?
          It is not simply the combination of flour, sugar, butter, and eggs.
          No: this would be far too naïve.
          Baking is the materialization of <span style="color:#e73b42;">comfort itself</span>.
          When we bake, we engage in a ritual that attempts to suspend the chaos of the world through the illusion of control: precise measurements, preheated ovens, perfectly timed rotations of trays.
          And yet, as any baker knows, this control is always incomplete. The cake may rise, or it may collapse;
          the dough may refuse to proof. The oven, that domestic abyss, stares back.
          </p>

          <p class="recipe-description">
          But in this gap (between intention and outcome) lies the <span style="color:#e73b42;">zen of baking</span>.
          We submit ourselves to a process that resists total mastery. The mind quiets as the hands work.
          The self dissolves into the rhythm of kneading, folding, and whisking.
          In baking, the most mundane gestures become philosophical: the transformation of raw matter into something tender, fragrant, <span style="color:#e73b42;">shareable</span>.
          Is this not, in a way, an allegory of all human creation?
          We impose form upon chaos, and call it dessert.
          </p>

          <p class="recipe-description">
          Culturally, baking binds us in a way that predates language.
          Across centuries and continents, <span style="color:#e73b42;">the act of sharing</span> bread, cake, or cookie functions as a social contract - a small edible utopia.
          You offer someone a slice, a biscuit, a still-warm loaf, and for a fleeting moment the alienation of modern life is suspended.
          Even the recipes themselves - whether original inventions, found online, or passed from one colleague's grandmother to another's notebook - form a <span style="color:#e73b42;">network</span> of borrowed gestures and shared <span style="color:#e73b42;">community</span>.
          </p>

          <p class="recipe-description">
          So, as you explore these recipes, remember: you are not merely reproducing instructions.
          You are reenacting an ancient dialectic between chaos and order, solitude and <span style="color:#e73b42;">community</span>, scarcity and indulgence.
