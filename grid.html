<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chomp recipes</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ---------------------------------------------------- */
    /* === BASE STYLES & LAYOUT === */
    /* ---------------------------------------------------- */

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fdfdfd;
      color: #353535;
      line-height: 1.7;
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 300px;
      background-color: #f5f5f5;
      border-right: 1px solid #e0e0e0;
      overflow-y: auto;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
    }

    .recipe-list-container {
      position: relative;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      flex-grow: 1;
      /* Mask for fading effect at the bottom */
      mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 95%, transparent 100%);
    }

    .sidebar-header {
      padding: 30px 20px 20px 20px;
      text-align: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .sidebar-title {
      font-size: 1.6em;
      font-weight: 300;
      color: #e73b42;
      flex-shrink: 0;
    }

    /* ---------------------------------------------------- */
    /* === SEARCH, SORT & LIST ITEMS (SIDEBAR) === */
    /* ---------------------------------------------------- */

    .search-box {
      width: calc(100% - 40px);
      margin: 0 20px 20px 20px;
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #434343;
      border-radius: 8px;
      background-color: #ffffff;
      color: #7d7d7d;
      flex-shrink: 0;
    }

    .search-box:focus { outline: none; border-color: #e73b42; }

    .recipe-list { list-style: none; padding: 0; margin: 0; }

    .recipe-item {
      padding: 14px 14px;
      cursor: pointer;
      border-bottom: 1px solid #e0e0e0;
      transition: background-color 0.2s;
      color: #7d7d7d;
    }

    .recipe-item:last-child { border-bottom: none; }

    .recipe-item:hover { background-color: #f0f0f0; }

    .recipe-item.active {
      background-color: #e73b42;
      color: #ffffff;
    }

    .recipe-name {
      font-weight: 400;
      font-size: .9em;
    }

    .recipe-item.active .recipe-time { color: rgba(255, 255, 255, 0.8); }

    /* Sticky Indicator and Shadow */
    .sticky-indicator {
      position: sticky;
      bottom: 0;
      text-align: center;
      background: rgba(253,253,253,0.9);
      padding: 8px 0;
      font-size: 0.85em;
      color: #777;
      opacity: 1;
      transition: opacity 0.3s ease;
      display: none;
    }

    .top-shadow {
      position: sticky;
      top: 0;
      width: 100%;
      height: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
      background:
        linear-gradient(to bottom,
          rgba(253,253,253,1) 0%,
          rgba(253,253,253,0) 90%),
        linear-gradient(to bottom,
          rgba(0,0,0,0.15),
          rgba(0,0,0,0));
    }


    /* ---------------------------------------------------- */
    /* === RECIPE CONTENT & HOME VIEW === */
    /* ---------------------------------------------------- */

    .recipe-content {
      flex: 1;
      overflow-y: auto;
      padding: 80px 50px;
      max-width: 1200px; 
      margin: 0 auto;
    }

    .recipe-header { margin-bottom: 25px; }

    .recipe-title {
      font-size: 1.9em;
      font-weight: 450;
      color: #e73b42;
      margin-bottom: 25px;
      line-height: 1.2;
    }

    .recipe-meta {
      color: #9d9d9d;
      font-size: 0.90em;
      margin-bottom: 25px;
    }
    .recipe-meta span { margin-right: 0 !important; }

    /* Base styles for description (used for both recipe and manifesto) */
    .recipe-description {
      font-weight: 300;
      line-height: 1.8;
      margin-bottom: 25px;
      font-size: 1em;
    }

    .recipe-image {
      display: block;
      max-width: 50%;
      width: auto;
      height: auto;
      border-radius: 8px;
      margin: 0 auto 20px auto;
    }

    /* Home/Manifesto Specific Styles */
    .home-text {
      text-align: left;
      padding: 0;
      max-width: 750px;
      margin: 0 auto;
      font-size: 1.05em;
      font-family: 'Inter', sans-serif;
      line-height: 1.85;
    }

    .home-text .home-image {
      width: 100%;
      max-width: 300px;
      height: auto;
      margin-bottom: 30px;
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .home-text .recipe-title {
      font-weight: 550 !important;
      margin-bottom: 15px;
    }

    .home-text,
    .home-text .recipe-description {
      color: #353535 !important;
      font-size: 1em !important;
      line-height: 1.9 !important;
    }

    /* ---------------------------------------------------- */
    /* === GRID VIEW STYLES & CONTROLS === */
    /* ---------------------------------------------------- */
    .grid-view {
      padding: 40px 50px;
      max-width: 100%; 
      margin: 0 auto;
    }

    .recipe-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 30px;
    }

    .recipe-card {
      background-color: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .recipe-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .card-image {
      width: 100%;
      height: 200px; 
      object-fit: cover;
      border-bottom: 1px solid #e0e0e0;
    }

    .card-image-placeholder {
      width: 100%;
      height: 200px;
      background-color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9em;
      color: #9d9d9d;
      font-weight: 300;
      border-bottom: 1px solid #e0e0e0;
    }

    .card-content {
      padding: 15px;
    }

    .card-title {
      font-size: 1.15em;
      font-weight: 600;
      color: #353535;
      margin-bottom: 5px;
      line-height: 1.3;
    }

    .card-description {
      font-size: 0.9em;
      color: #7d7d7d;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
    }

    .card-time {
      font-size: 0.8em;
      color: #e73b42;
      font-weight: 600;
    }

    .grid-controls {
      display: flex;
      flex-wrap: wrap; /* NEW: Allows controls to wrap */
      gap: 15px;
      align-items: center;
      margin-bottom: 30px;
      justify-content: flex-start;
      padding: 0 10px;
    }

    .grid-controls select {
      padding: 8px 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    
    .clear-filters-btn {
      font-family: 'Inter', sans-serif !important;
      font-size: 0.9em;
      padding: 8px 12px;
      background: transparent;
      border: 1px solid #9d9d9d;
      color: #7d7d7d;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .clear-filters-btn:hover {
      border-color: #E73B42;
      color: #E73B42;
    }


    /* ---------------------------------------------------- */
    /* === ACTIONS & SECTIONS (FULL RECIPE) === */
    /* ---------------------------------------------------- */

    .recipe-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .recipe-action-button {
      font-family: 'Inter', sans-serif !important;
      font-size: 0.95em;
      padding: 6px 10px;
      background: transparent;
      border: 1px solid #E73B42;
      color: #E73B42;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .recipe-action-button:hover {
      background-color: #E73B42;
      color: white;
    }

    .section-title {
      color: #E73B42;
      font-size: 1.2em;
      font-weight: 700;
      margin: 20px 0 20px 0;
    }

    .ingredients-list { list-style: none; margin-bottom: 25px; }

    .ingredient-item {
      padding: 6px 0 6px 16px;
      border-left: 3px solid #E73B42;
      margin-bottom: 8px;
      font-weight: 300;
    }

    .instructions-list { list-style: none; counter-reset: step-counter; }

    .instruction-item {
      counter-increment: step-counter;
      margin-bottom: 20px;
      padding-left: 40px;
      position: relative;
      font-weight: 300;
      line-height: 1.8;
    }

    .instruction-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 28px;
      height: 28px;
      background-color: #E73B42;
      color: #ffffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;
      font-size: 0.9em;
    }

    .notes-section {
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 10px;
      font-weight: 300;
    }

    .no-recipe {
      padding: 20px;
      text-align: center;
      color: #666666;
      font-size: 0.95em;
    }

    a.email-link { color: #E73B42; font-weight: 700; text-decoration: none; }

    /* Links in recipe content (from markdown parsing) */
    .recipe-content a { color: #E73B42; font-weight: 400; text-decoration: none; }

    /* ---------------------------------------------------- */
    /* === MEDIA QUERIES === */
    /* ---------------------------------------------------- */

    @media (max-width: 768px) {
      .recipe-list-container { max-height: calc(56px * 3); }
      body { flex-direction: column; }
      .sidebar { 
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #e0e0e0;
        max-height: 40vh;
      }
      .recipe-content { padding: 20px; }
      .recipe-image { max-width: 80%; }
      
      .recipe-cards-container { grid-template-columns: repeat(auto-fill, minmax(100%, 1fr)); }
      .grid-controls { flex-direction: column; align-items: stretch; }
    }

    @media print {
      .sidebar, .search-box, .print-button, .copy-link-button, .sidebar-header, .recipe-list-container, .recipe-actions, .recipe-action-button, .grid-controls, .pagination-area {
        display: none !important;
      }
      body { display: block; min-height: auto; color: #000000; }
      .recipe-content { width: 100%; max-width: 100%; margin: 0; padding: 0; }
      .recipe-title { color: #000000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .recipe-meta, .recipe-description { color: #333333; }
      .section-title { color: #333333 !important; }
      .notes-section { background-color: transparent; border: 1px dashed #cccccc; }
      .ingredient-item { border-left-color: #cccccc !important; }
      .instruction-item::before { background-color: #000000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header" onclick="resetRecipeView()" style="cursor: pointer;">
      <div class="sidebar-title">Rituals / Recipes</div>
      <a href="#grid" id="gridViewLink" style="font-size:0.85em; color: #E73B42; margin-top: 5px; display: block; text-decoration: none;">View All Recipes (Grid)</a>
    </div>
    
    <div style="padding: 0 20px 10px 20px; flex-shrink: 0;">
      <select id="sidebar-sort-by" style="width:100%; padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 4px;">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="newest">Sort: Newest</option>
          <option value="rating">Sort: Best Rated</option>
          <option value="time">Sort: Quickest Time</option>
      </select>
    </div>

    <input type="text" class="search-box" id="searchBox" placeholder="search recipes...">
    
    <div class="recipe-list-container">
        <ul class="recipe-list" id="recipeList"></ul>
        <div id="stickyIndicator" class="sticky-indicator"></div>
        <div class="top-shadow"></div>
        <div class="no-results" id="noResults" style="display: none;">no recipes found</div>
    </div>
  </div>

  <div class="recipe-content" id="recipeContent"></div>

  <script>
    let recipes = [];
    let currentRecipe = null;
    let currentGridPage = 0;
    const RECIPES_PER_PAGE = 15;

    function printRecipe() { window.print(); }

    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    }

    function parseMarkdown(text) {
      if (!text) return text;
      // Converts [text](link) to HTML <a> tag
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
      // Handles source objects from the JSON
      if (typeof text === 'object' && text !== null && Array.isArray(text)) {
          return text.map(item => {
              if (item.text && item.href) {
                  return `<a href="${item.href}" target="_blank" rel="noopener noreferrer">${item.text}</a>`;
              }
              return item.text || item;
          }).join('');
      }
      return text;
    }

    function copyPermalink() {
        if (!currentRecipe || !currentRecipe.slug) return;
        const url = `${window.location.origin}${window.location.pathname}?slug=${encodeURIComponent(currentRecipe.slug)}`;
        navigator.clipboard.writeText(url).then(() => {
            alert('Permalink copied to clipboard!');
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    }

    function parseTime(timeString) {
        if (!timeString) return Infinity; 
        
        // Handle "65-80 minutes" by taking the lower bound
        const rangeMatch = String(timeString).match(/^(\d+)/);
        const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
        
        const hoursMatch = String(timeString).match(/(\d+)\s*h/);
        const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
        
        const minutesMatch = String(timeString).match(/(\d+)\s*min/);
        const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
        
        if (hours + minutes > 0) {
            return hours + minutes;
        } else if (rangeMinutes > 0) {
            return rangeMinutes;
        }
        return Infinity;
    }

    // NEW UTILITY FUNCTION
    function assignDishType(title) {
        const lower = title.toLowerCase();
        if (lower.includes('cake') || lower.includes('torte') || lower.includes('pie') || lower.includes('brûlée')) return 'Dessert/Pastry';
        if (lower.includes('cookie') || lower.includes('cookies')) return 'Cookie/Bar';
        if (lower.includes('custard')) return 'Frozen Dessert';
        if (lower.includes('pudding')) return 'Pudding/Cream';
        if (lower.includes('taco') || lower.includes('main dish')) return 'Main Dish'; 
        if (lower.includes('soup')) return 'Soup'; 
        return 'Other Baked Goods';
    }
    
    function sortRecipes(recipesToSort, sortBy) {
        switch (sortBy) {
            case 'time':
                recipesToSort.sort((a, b) => a.totalTimeInMinutes - b.totalTimeInMinutes);
                break;
            case 'rating':
                recipesToSort.sort((a, b) => b.ratingScore - a.ratingScore);
                break;
            case 'newest':
                recipesToSort.reverse(); 
                break;
            case 'alphabetical':
            default:
                recipesToSort.sort((a, b) => 
                    a.title.toLowerCase() < b.title.toLowerCase() ? -1 : 
                    a.title.toLowerCase() > b.title.toLowerCase() ? 1 : 0
                );
                break;
        }
    }


    const HOME_CONTENT_HTML = `
      <div class="home-text">
          <img src="/images/Chomp Chomp logos.jpeg" alt="Chomp Recipes Logo" class="home-image">
          <h1 class="recipe-title" style="font-size:1.8em;">Recipes & Rituals</h1>
          <h2 class="section-title manifesto-title" style="font-size:1.2em;">
            <span class="manifesto-line-1">A Baking Manifesto</span>
          </h2>

          <p class="recipe-description">
          Baking. What is baking, <em>really</em>?
          It is not simply the combination of flour, sugar, butter, and eggs.
          No: this would be far too naïve.
          Baking is the materialization of <span style="color:#e73b42;">comfort itself</span>.
          When we bake, we engage in a ritual that attempts to suspend the chaos of the world through the illusion of control: precise measurements, preheated ovens, perfectly timed rotations of trays.
          And yet, as any baker knows, this control is always incomplete. The cake may rise, or it may collapse;
          the dough may refuse to proof. The oven, that domestic abyss, stares back.
          </p>

          <p class="recipe-description">
          But in this gap (between intention and outcome) lies the <span style="color:#e73b42;">zen of baking</span>.
          We submit ourselves to a process that resists total mastery. The mind quiets as the hands work.
          The self dissolves into the rhythm of kneading, folding, and whisking.
          In baking, the most mundane gestures become philosophical: the transformation of raw matter into something tender, fragrant, <span style="color:#e73b42;">shareable</span>.
          Is this not, in a way, an allegory of all human creation?
          We impose form upon chaos, and call it dessert.
          </p>

          <p class="recipe-description">
          Culturally, baking binds us in a way that predates language.
          Across centuries and continents, <span style="color:#e73b42;">the act of sharing</span> bread, cake, or cookie functions as a social contract - a small edible utopia.
          You offer someone a slice, a biscuit, a still-warm loaf, and for a fleeting moment the alienation of modern life is suspended.
          Even the recipes themselves - whether original inventions, found online, or passed from one colleague's grandmother to another's notebook - form a <span style="color:#e73b42;">network</span> of borrowed gestures and shared <span style="color:#e73b42;">community</span>.
          </p>

          <p class="recipe-description">
          So, as you explore these recipes, remember: you are not merely reproducing instructions.
          You are reenacting an ancient dialectic between chaos and order, solitude and <span style="color:#e73b42;">community</span>, scarcity and indulgence.
          You are, in the truest sense, baking the <span style="color:#e73b42;">striving toward transcendence</span>.
          </p>

          <h2 class="section-title" style="font-size:1.2em;">Bake first, theorize later</h2>

          <p class="recipe-description">
          Scroll through the recipes, or search by keyword.
          </p>

          <p class="recipe-description">
          Of course, as with all things in life, the search itself may be more revealing than the finding—the keyword is merely <span style="color:#e73b42;">the symptom of desire</span>!
          </p>

          <p class="recipe-description">
          Because baking, like theory, thrives on exchange and variation, I'm always looking for something new.
          If you have a recipe - your grandmother's secret torte, your own <span style="color:#e73b42;">subversive</span> take on the cookie, or something you found in a forgotten corner of the internet - please send it to me.
          I'll add it here, with full credit, so that our <span style="color:#e73b42;">collective archive</span> of baked transcendence may continue to grow.
          </p>

          <p class="recipe-description">
          <a href="mailto:baking@chomp.ltd" class="email-link">baking@chomp.ltd</a>
          </p>
  
          <p class="recipe-description">
          <a href="https://www.chomp.ltd" class="email-link">chomp chomp: cookies, etc.</a>
          </p>
   
          <p class="recipe-description">
          <a href="https://tools.chomp.ltd" class="email-link">chomp chomp: tools</a>
          </p> 
      </div>
    `;

    function resetRecipeView() {
        document.querySelectorAll('.recipe-item').forEach(item => item.classList.remove('active'));
        document.getElementById('recipeContent').innerHTML = HOME_CONTENT_HTML;
        currentRecipe = null;
        history.replaceState(null, '', window.location.pathname);
    }

    function updateStickyIndicator() {
      const list = document.querySelector('.recipe-list-container');
      const indicator = document.getElementById('stickyIndicator');
      const topShadow = document.querySelector('.top-shadow');
      if (!list || !indicator) return;

      const isScrollable = list.scrollHeight > list.clientHeight;
      if (!isScrollable) {
        indicator.style.display = 'none';
        if (topShadow) topShadow.style.opacity = 0;
        return;
      }

      indicator.style.display = 'block';
      const isMobile = window.innerWidth < 768;
      indicator.textContent = isMobile ?
        "↓ scroll for more" : "↓ scroll for more recipes";

      const atTop = list.scrollTop <= 1;
      indicator.style.opacity = atTop ? 1 : 0;
      if (topShadow) topShadow.style.opacity = atTop ? 0 : 1;
      if (!list._hasStickyScrollHandler) {
        list.addEventListener('scroll', () => {
          const nowAtTop = list.scrollTop <= 1;
          indicator.style.opacity = nowAtTop ? 1 : 0;
          if (topShadow) {
            topShadow.style.opacity = nowAtTop ? 0 : 1;
          }
        });
        list._hasStickyScrollHandler = true;
      }
    }

    function openRecipeFromURL() {
      const params = new URLSearchParams(window.location.search);
      const slugParam = params.get('slug');

      if (!slugParam || slugParam.trim() === '') return false;
      let target = recipes.find(r => r.slug === slugParam.trim());

      if (!target) return false;
      const recipeList = document.getElementById('recipeList');
      const items = recipeList.querySelectorAll('.recipe-item');

      items.forEach(item => {
        const nameEl = item.querySelector('.recipe-name');
        if (nameEl && nameEl.textContent.trim() === target.title) {
          selectRecipe(target, item);
        }
      });
      return true;
    }

    async function loadRecipes() {
      try {
        const response = await fetch('recipes.json'); 
        recipes = await response.json();

        recipes.forEach(r => {
          if (!r.slug) {
            r.slug = generateSlug(r.title);
          }
          // Data Enrichment
          r.totalTimeInMinutes = parseTime(r.totalTime || r.cookTime);
          r.ratingScore = Math.random() * 1.5 + 3.5; // Simulate rating (3.5 to 5.0)
          r.dishType = assignDishType(r.title); // NEW: Assign dish type for filtering
        });
        
        // Initial sort for the sidebar list
        sortRecipes(recipes, 'alphabetical');
        
        displayRecipeList(recipes);
        updateStickyIndicator(); 

        if (window.location.hash === '#grid') {
            displayGridPage(recipes);
        } else if (!openRecipeFromURL()) {
            resetRecipeView();
        }
      } catch (error) { 
        console.error('Error loading recipes:', error);
        document.getElementById('recipeContent').innerHTML = `
            <div class="no-recipe">
                <p>Unable to load recipes. Please ensure 'Chomp_Recipe_Site_JSON_Recipes.txt' is correctly formatted and accessible.</p>
            </div>
        `;
      }
    }

    function displayRecipeList(recipesToShow) {
      const recipeList = document.getElementById('recipeList');
      const noResults = document.getElementById('noResults');
      recipeList.innerHTML = '';
      if (!recipesToShow.length) { 
        noResults.style.display = 'block';
        return;
      }
      noResults.style.display = 'none';
      recipesToShow.forEach(recipe => {
        const li = document.createElement('li');
        li.className = 'recipe-item';
        li.onclick = () => selectRecipe(recipe, li);
        li.innerHTML = `<div class="recipe-name">${recipe.title}</div>`;
        
        if (currentRecipe && currentRecipe.slug === recipe.slug) {
            li.classList.add('active');
        }

        recipeList.appendChild(li);
      });
    }

    function selectRecipe(recipe, element) {
      currentRecipe = recipe;
      document.querySelectorAll('.recipe-item').forEach(item=>item.classList.remove('active'));
      if (element && element.classList) { 
          element.classList.add('active');
      }

      const content = document.getElementById('recipeContent');

      let metaInfo = [];
      if (recipe.prepTime) metaInfo.push(`<span>prep: ${recipe.prepTime}</span>`);
      if (recipe.cookTime) metaInfo.push(`<span>cook: ${recipe.cookTime}</span>`);
      if (recipe.totalTime) metaInfo.push(`<span>total: ${recipe.totalTime}</span>`);
      if (recipe.servings) metaInfo.push(`<span>servings: ${recipe.servings}</span>`);
      if (recipe.source) metaInfo.push(`<span>source: ${parseMarkdown(recipe.source)}</span>`);
      if (recipe.category && recipe.category !== 'null') metaInfo.push(`<span>category: ${recipe.category}</span>`);

      let imageHTML = recipe.image?`<img src="${recipe.image}" alt="${recipe.title}" class="recipe-image">`:'';
      let descriptionHTML = recipe.description?`<div class="recipe-description">${parseMarkdown(recipe.description)}</div>`:'';
      
      const ingredientsHTML = recipe.ingredients.map(i => {
          if (typeof i === 'string') return `<li class="ingredient-item">${i}</li>`;
          return `<li class="ingredient-item">${parseMarkdown(i)}</li>`;
      }).join('');

      const instructionsHTML = recipe.instructions.map(i=>`<li class="instruction-item">${parseMarkdown(i)}</li>`).join('');
      let notesHTML = recipe.notes?`<div class="section-title">notes</div><div class="notes-section">${parseMarkdown(recipe.notes)}</div>`:'';

      if (recipe.slug) {
        const newUrl = `${window.location.pathname}?slug=${encodeURIComponent(recipe.slug)}`;
        history.replaceState(null, '', newUrl);
      }

      content.innerHTML = `
        <div class="recipe-header">
          <h1 class="recipe-title">${recipe.title}</h1>
          <div class="recipe-meta">${metaInfo.join(' | ')}</div>
          <div class="recipe-actions">
            <button onclick="printRecipe()" class="recipe-action-button">Print</button>
            <button onclick="copyPermalink()" class="recipe-action-button">Copy Link</button>
          </div>
        </div>
        ${descriptionHTML}${imageHTML}
        <div class="section-title">ingredients</div>
        <ul class="ingredients-list">${ingredientsHTML}</ul>
        <div class="section-title">instructions</div>
        <ol class="instructions-list">${instructionsHTML}</ol>
        ${notesHTML}
      `;
    }

    // --- GRID VIEW FILTERING, SORTING, AND RENDERING ---
    
    function getUniqueFilterOptions(key) {
        const options = new Set();
        recipes.forEach(r => {
            if (r[key]) options.add(r[key]);
        });
        return Array.from(options).sort();
    }

    function renderCards(recipesToRender) {
        return recipesToRender.map(recipe => {
            const timeText = recipe.totalTimeInMinutes === Infinity ? 'Time N/A' : `${recipe.totalTimeInMinutes} min`;
            const imagePath = recipe.image && !recipe.image.startsWith('images/') ? `images/${recipe.image}` : recipe.image;
            
            const imageHTML = recipe.image 
                ? `<img src="${imagePath}" alt="${recipe.title}" class="card-image">`
                : `<div class="card-image-placeholder">No Image Available</div>`;
            
            return `
                <div class="recipe-card" onclick="selectRecipeFromGrid('${recipe.slug}')">
                    ${imageHTML}
                    <div class="card-content">
                        <div class="card-title">${recipe.title}</div>
                        <div class="card-description">${recipe.description || 'A delicious recipe waiting to be made!'}</div>
                        <div class="card-time">⭐️ ${recipe.ratingScore.toFixed(1)} | ${timeText}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function selectRecipeFromGrid(slug) {
        const target = recipes.find(r => r.slug === slug);
        if (!target) return;
        
        const newUrl = `${window.location.pathname}?slug=${encodeURIComponent(target.slug)}`;
        history.replaceState(null, '', newUrl); 

        const recipeList = document.getElementById('recipeList');
        const item = Array.from(recipeList.querySelectorAll('.recipe-item'))
            .find(el => el.querySelector('.recipe-name').textContent.trim() === target.title);
            
        selectRecipe(target, item || {}); 
    }

    function filterAndSortGrid() {
        const sortBy = document.getElementById('grid-sort-by').value;
        const categoryFilter = document.getElementById('filter-category').value;
        const typeFilter = document.getElementById('filter-type').value;

        let recipesToFilter = [...recipes]; 

        // 1. Filtering
        if (categoryFilter !== 'all') {
            recipesToFilter = recipesToFilter.filter(r => r.category === categoryFilter);
        }
        if (typeFilter !== 'all') {
            recipesToFilter = recipesToFilter.filter(r => r.dishType === typeFilter);
        }

        // 2. Sorting
        sortRecipes(recipesToFilter, sortBy);

        // 3. Render
        currentGridPage = 0;
        const initialCards = renderCards(recipesToFilter.slice(0, RECIPES_PER_PAGE));
        
        const container = document.getElementById('gridCardsContainer');
        if (container) container.innerHTML = initialCards;

        // 4. Update Load More Button
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (loadMoreBtn) {
            if (recipesToFilter.length <= RECIPES_PER_PAGE) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'inline-block';
                loadMoreBtn.onclick = () => loadMoreRecipes(recipesToFilter);
            }
        }
    }

    function loadMoreRecipes(filteredRecipes) {
        currentGridPage++;
        const startIndex = currentGridPage * RECIPES_PER_PAGE;
        const endIndex = startIndex + RECIPES_PER_PAGE;
        const nextBatch = filteredRecipes.slice(startIndex, endIndex);

        const container = document.getElementById('gridCardsContainer');
        if (container) container.insertAdjacentHTML('beforeend', renderCards(nextBatch));
        
        // Hide button if all recipes are loaded
        if (endIndex >= filteredRecipes.length) {
            document.getElementById('load-more-btn').style.display = 'none';
        }
    }

    function clearAllFilters() {
        // Reset all filter and sort selectors
        document.getElementById('filter-category').value = 'all';
        document.getElementById('filter-type').value = 'all';
        document.getElementById('grid-sort-by').value = 'alphabetical';
        
        // Re-run the filtering/sorting function with default values
        filterAndSortGrid();
    }


    function displayGridPage(initialRecipes) {
        const content = document.getElementById('recipeContent');

        // Get filter options dynamically
        const categories = getUniqueFilterOptions('category');
        const dishTypes = getUniqueFilterOptions('dishType');

        const filterOptionsHTML = (options, id, label) => `
            <select id="${id}" onchange="filterAndSortGrid()">
                <option value="all">Filter by ${label}</option>
                ${options.map(o => `<option value="${o}">${o}</option>`).join('')}
            </select>
        `;

        const gridControlsHTML = `
          <div class="grid-controls">
            ${filterOptionsHTML(categories, 'filter-category', 'Category')}
            ${filterOptionsHTML(dishTypes, 'filter-type', 'Type')}
            
            <select id="grid-sort-by" onchange="filterAndSortGrid()">
              <option value="alphabetical">Sort: A-Z</option>
              <option value="newest">Sort: Newest</option>
              <option value="rating">Sort: Highest Rated</option>
              <option value="time">Sort: Quickest Time</option>
            </select>

            <button class="clear-filters-btn" onclick="clearAllFilters()">Clear Filters</button>
          </div>
        `;

        let recipesToDisplay = [...initialRecipes];
        sortRecipes(recipesToDisplay, 'alphabetical');
        currentGridPage = 0;
        const initialCards = renderCards(recipesToDisplay.slice(0, RECIPES_PER_PAGE));
        
        content.innerHTML = `
            <div class="grid-view">
                <h1 class="recipe-title" style="text-align:center;">All Recipes</h1>
                ${gridControlsHTML}
                <div class="recipe-cards-container" id="gridCardsContainer">
                    ${initialCards}
                </div>
                <div class="pagination-area" style="text-align:center; margin-top: 40px;">
                  <button id="load-more-btn" class="recipe-action-button" 
                          ${recipesToDisplay.length <= RECIPES_PER_PAGE ? 'style="display:none;"' : ''}>Load More Recipes</button>
                </div>
            </div>
        `;

        // Attach load more handler to initial unfiltered list
        document.getElementById('load-more-btn').onclick = () => loadMoreRecipes(recipesToDisplay);

        // Set the hash in the URL
        history.replaceState(null, '', window.location.pathname + '#grid');
    }

    // --- EVENT LISTENERS ---

    // 1. Sidebar Search
    document.getElementById('searchBox').addEventListener('input', e=>{
      const searchTerm = e.target.value.toLowerCase();
      const filtered = recipes.filter(r=>
        r.title.toLowerCase().includes(searchTerm) ||
        (r.description&&r.description.toLowerCase().includes(searchTerm)) ||
        r.ingredients.some(i=>i.toLowerCase().includes(searchTerm))
      );
      displayRecipeList(filtered);
      updateStickyIndicator();
    });

    // 2. Sidebar Sort Selector
    document.getElementById('sidebar-sort-by').addEventListener('change', e => {
        sortRecipes(recipes, e.target.value);
        displayRecipeList(recipes); 
    });

    // 3. Hash Change Listener (for back button/direct link to grid)
    window.addEventListener('hashchange', () => {
        if (window.location.hash === '#grid' && recipes.length > 0) {
            displayGridPage(recipes);
        } else if (window.location.hash === '' && !window.location.search) {
            resetRecipeView();
        }
    });

    // 4. Initial Load and Resize
    loadRecipes();
    
    window.addEventListener('resize', () => {
      updateStickyIndicator();
    });

  </script>
</body>
</html>
